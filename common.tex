% This file should only contain things that can go into any kind of document.

% TODO: keyvals: draft (obvious), debug (load blind text packages), strict (whether to fail or fallback, e.g. for luatex-only features like specific fonts)
% TODO: math: automatically replace i/j i/jmath (have an option to prevent that)
% TODO: support passing style options to most of the commands, 
%       e.g. \vc[vecdisplay=bm]{x}

% Use pgfkeys for everything [[[1
% Early packages loads required for handling the configuration.
\RequirePackage{pgfkeys}
\RequirePackage{xparse}
\RequirePackage{ifxetex}
\RequirePackage{ifluatex}
% TODO: ifs for: luatex, xelatex, beamer

% Key-value interface: convenient access to the namespace
\ExplSyntaxOn

\cs_new:Npn \__wisper_keys:n #1 { \pgfkeys{/wisper/.cd,#1} }
\cs_new:Npn \__wisper_doc_style:n #1 { \pgfkeys{/wisper/document/.cd,#1} }

\cs_new_eq:NN \DocumentStyle \__wisper_doc_style:n

% Document class [[[1
% Conditionals and switches [[[2
% should accept article, book, presentation, letter
\__wisper_doc_style:n {type/.initial=article}
\prg_new_conditional:Npnn \__wisper_if_document_type:n #1
  { T, F, TF}
  { 
    \__wisper_doc_style:n {type/.get=\tempa}
    \str_if_eq:nVTF {#1} \tempa
      { \prg_return_true: }
      { \prg_return_false: }
  }

% TODO: support IfDocTypeTF{article,book}, i.e. comma-separated list
\cs_new_eq:NN \IfDocTypeT \__wisper_if_document_type:nT
\cs_new_eq:NN \IfDocTypeF \__wisper_if_document_type:nF
\cs_new_eq:NN \IfDocTypeTF \__wisper_if_document_type:nTF

% TODO: automate the following definitions
\cs_new:Npn \IfPresentationT #1 { \__wisper_if_document_type:nT {presentation} {#1} }
\cs_new:Npn \IfPresentationF #1 { \__wisper_if_document_type:nF {presentation} {#1} }
\cs_new:Npn \IfPresentationTF #1#2 { \__wisper_if_document_type:nTF {presentation} {#1} {#2} }

\cs_new:Npn \IfLetterT #1 { \__wisper_if_document_type:nT {letter} {#1} }
\cs_new:Npn \IfLetterF #1 { \__wisper_if_document_type:nF {letter} {#1} }
\cs_new:Npn \IfLetterTF #1#2 { \__wisper_if_document_type:nTF {letter} {#1} {#2} }

\cs_new:Npn \IfArticleT #1 { \__wisper_if_document_type:nT {article} {#1} }
\cs_new:Npn \IfArticleF #1 { \__wisper_if_document_type:nF {article} {#1} }
\cs_new:Npn \IfArticleTF #1#2 { \__wisper_if_document_type:nTF {article} {#1} {#2} }

\cs_new:Npn \IfBookT #1 { \__wisper_if_document_type:nT {book} {#1} }
\cs_new:Npn \IfBookF #1 { \__wisper_if_document_type:nF {book} {#1} }
\cs_new:Npn \IfBookTF #1#2 { \__wisper_if_document_type:nTF {book} {#1} {#2} }

\cs_new:Npn \SwitchDocType #1#2
  { 
    \__wisper_doc_style:n {type/.get=\tempa}
    \str_case:onF \tempa
    { #1 }  % should contain lines of {type}{code} pairs
    { #2 }
  }

\ExplSyntaxOff

% Define the key-value interface [[[1
% Font handling [[[2
\ExplSyntaxOn

\__wisper_doc_style:n
  {
    font/preset/.cd,
    .is~choice,

    lmodern/.style={
      internal/load~font/.code={
        \usepackage{lmodern}
      }
    },

    fira/.style={
      internal/load~font/.code={
        % Mozilla Fira Sans, requires XeLaTeX or LuaLaTex TODO: raise error
        \usepackage[sfdefault]{FiraSans}
        \usepackage{FiraMono}
      }
    },

    garamond/.style={
      internal/load~font/.code={
        % URW-Garamond: A free garamond font, supposedly good for books but to fragile
        %   for presentations. Math fonts provided by the mathdesign project
        \usepackage[urw-garamond]{mathdesign}
        % FIXME: maybe drop this? PagellaX is better anyway. At least give a
        % warning.
        % TODO: matching sans font
      }
    },

    palatino/.style={
      internal/load~font/.code={
        \usepackage[osf]{mathpazo}
      }
    },

    TexGyre/.style={
      internal/load~font/.code={
        \usepackage{amsthm}  % preload amsthm to suppress error due to newpxmath redfining \openbox
        \usepackage[vvarbb]{newpxmath}
        \ifluatex
          \usepackage[no-math]{fontspec}  % TODO: tex/luatex switch
          % TODO: ensure correct small caps, \usepackage[largesc]{newpxtext}
          \setmainfont{TeXGyrePagellaX}[Numbers=OldStyle]
          \setsansfont{TeXGyreHeros}
          \newfontfamily\liningnumtext{TeXGyrePagellaX}[Numbers=Lining]
        \else
          \usepackage[largesc]{newpxtext}
          \useosf
        \fi
        \linespread{1.05} 
      }
    },

  }

\__wisper_doc_style:n {font/preset=TexGyre}

%\mhchemoptions{textfontcommand=\liningnumtext}
%\IfPresentationT{\renewcommand*{\bibfont}{\scriptsize}}

% Adjust layout.
% TODO: only for KOMA classes
\IfDocTypeT{book}{\KOMAoptions{DIV=last}}

\ExplSyntaxOff

% Footnotes [[[2

\ExplSyntaxOn

\newif\ifmultiplefootnotes

\__wisper_doc_style:n 
  {
    footnotes/.cd,

    multiple/.is~if,
    %multiple=false,
  }

\ExplSyntaxOff

% Citations [[[2
\ExplSyntaxOn
\__wisper_doc_style:n
  {
    cite/style/.is~choice,
    cite/style/super/.style={ },
    cite/style/bracket/.style={ },

    %cite/footnote/.style={
    %  footnotes/multiple=true,
    %},
  }


% Tufte-style [[[2
\__wisper_doc_style:n
  {
    cite/style=super,
    %cite/footnote,

    internal/load~sidenotes/.code={},
    sidenotes/enable/.style={
      internal/load~sidenotes/.code={
        \IfPresentationF{
          \usepackage{sidenotes}
        }
      },
    }
  }

\ExplSyntaxOff

% Load all the things [[[1
% Document class [[[2
\SwitchDocType
  {
    % TODO: draft option, final option
    {article}{\documentclass[a4paper]{article}}
    {presentation}{\documentclass{beamer}}
    {letter}{\documentclass{scrlttr2}}
    {book}{\documentclass{book}}
    {scrbook}{\documentclass[english, ngerman, a4paper, BCOR=0mm, DIV=10, pagesize]{scrbook}}
  }
  {
    % TODO: use the .is choice handler to prevent this in the first place
    \PackageError{---}{Invalid document type}{No help here.}
  }

% Early Package loads [[[2
\usepackage[main=english]{babel}
\usepackage[T1]{fontenc}
\DocumentStyle{internal/load font}

% Load packages [[[1
\input{common_packages.tex}
\input{common_packages_late.tex}

% Configure packages, define commands [[[1

% Generic layout-related packages [[[2
\usepackage[strict]{changepage}
\IfPresentationF{\usepackage{sidenotes}}

% Footnotes [[[2
\usepackage{bigfoot}
\DeclareNewFootnote{default}[alph]

% Citations [[[2
\let\footnote\footnotedefault
\let\footnotemark\footnotemarkdefault
\let\footnotetext\footnotetextdefault
\DeclareNewFootnote{Cite}

% Layout for KOMA [[[2
\IfDocTypeT{book}
  {
    % Fix chapter/section titles defaulting to sans (i.e. CM) fonts
    \setkomafont{disposition}{\normalfont\bfseries}
    \KOMAoptions{headings=normal}
    % Fix fonts in the toc
    \setkomafont{chapterentry}{\normalfont\bfseries}
    % fix item font in descriptions and enumerates
    \setkomafont{descriptionlabel}{\normalfont\bfseries}
    \setkomafont{labelinglabel}{\normalfont\bfseries}
    % Suppress warnings on font fallback
    \renewcommand\labelitemi{{\fontfamily{cmr}\selectfont\textbullet}}
    \renewcommand\labelitemiii{{\fontfamily{cmr}\selectfont\textasteriskcentered}}
    \renewcommand\labelitemiv{{\fontfamily{cmr}\selectfont\textperiodcentered}}
    %
    % Titlepage
    \KOMAoptions{titlepage=firstiscover}
    %
    % Footnotes
    \KOMAoptions{footnotes=multiple}
    \renewcommand{\multfootsep}{,}
    %
    % Header/Footer
    \usepackage[draft=false]{scrlayer-scrpage}
    \pagestyle{scrheadings}
    \automark[chapter]{chapter}
    \automark*[section]{}
    \ihead{}
    \chead{\headmark}
    \ohead{\pagemark}
    \ifoot{}
    \cfoot{}
    \ofoot{}
    %\KOMAoptions{headsepline=true}
    %\KOMAoptions{footsepline=:0.5\textwidth, olines}
  }

% Colors [[[2
\usepackage{xcolor}
% define a few highlighting colors, from https://personal.sron.nl/~pault/
\definecolor{marklightblue}{HTML}{BBCCEE}
\definecolor{marklightteal}{HTML}{CCEEFF}
\definecolor{marklightgreen}{HTML}{CCDDAA}
\definecolor{marklightsand}{HTML}{EEEEBB}
\definecolor{marklightred}{HTML}{FFCCCC}
\definecolor{markdarkblue}{HTML}{222255}
\definecolor{markdarkteal}{HTML}{225555}
\definecolor{markdarkgreen}{HTML}{225522}
\definecolor{markdarksand}{HTML}{666633}
\definecolor{markdarkred}{HTML}{663333}


% Tables [[[2
% https://tex.stackexchange.com/a/2442/111880
% https://tex.stackexchange.com/a/12712/111880
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

% Figures, tables, ... [[[2
\DeclareCaptionStyle{myfigure}{font=footnotesize,%
                               labelfont=sc,%
                               }
\captionsetup{style=myfigure}  % default

\IfPresentationF
  {
    \DeclareCaptionJustification{raggedoutside}{\raggedoutside}
    \newcommand\raggedoutside
      {%
        \checkoddpage%
        \ifoddpage%
          \RaggedRight%
        \else%
          \RaggedLeft%
        \fi%
      }

  \NewDocumentEnvironment{flushinside}{}
    {%
      \checkoddpage%
      \bgroup%
      \ifoddpage%
        \flushleft%
      \else%
        \flushright%
      \fi%
    }
    {%
      \egroup%
    }

  \DeclareCaptionStyle{marginfigure}{justification=raggedoutside,%
                                     font=footnotesize,%
                                     labelfont=sc,%
                                     }

  \DeclareCaptionStyle{margintable}{justification=raggedoutside,%
                                    font=footnotesize,%
                                    labelfont=sc,%
                                    }

  \DeclareCaptionStyle{sidecaption}{justification=raggedoutside,%
                                    font=footnotesize,%
                                    labelfont=sc,%
                                    }
  \newlength{\realmarginparwidth}
  \setlength{\realmarginparwidth}{\marginparwidth}
  \addtolength{\realmarginparwidth}{\marginparsep}

  \DeclareCaptionStyle{widetable}{%justification=raggedoutside,%
                                  font=footnotesize,%
                                  labelfont=sc,%
                                  margin={0pt, \realmarginparwidth}
                                  }
  }

% Hyperlinks [[[2
\hypersetup{%
    colorlinks=true,
    linkcolor=black,  % for internal links, color is just too much
    citecolor=markdarkteal,
    filecolor=markdarkgreen,
    urlcolor=markdarkblue,
    bookmarksopen=true,
    bookmarksopenlevel=3
}


% Bibliography [[[2
% From http://www.khirevich.com/latex/footnote_citation/
% new command \sjcitep prints footnote citation above punctuation
\newlength{\spc} % declare a variable to save spacing value
% TODO: ensure that this works when there are non-cite footnotes on the same page
\NewDocumentCommand{\citep}{D<>{} o o m}{% new command with two arguments: optional (#1) and mandatory (#2)
        \settowidth{\spc}{#1}% set value of \spc variable to the width of #1 argument
        \addtolength{\spc}{-1.8\spc}% subtract from \spc about two (1.8) of its values making its magnitude negative
        #1% print the optional argument
        \hspace*{\spc}% print an additional negative spacing stored in \spc after #1
        \IfNoValueTF{#2}
            {\supershortnotecite{#4}}
            {\IfNoValueTF{#3}
                {\supershortnotecite[#2]{#4}}
                {\supershortnotecite[#2][#3]{#4}}}
    }% print (cite) the mandatory argument


% New Commands [[[2
% unnumbered section that shows up in the TOC
\newcommand{\tocsection}[1]{\section*{#1}\addcontentsline{toc}{section}{#1}}
% non-numbered subsection that works properly with hyperref
\newcommand{\nonumchapter}[1]{\phantomsection\addcontentsline{toc}{chapter}{#1}}
\newcommand{\nonumsection}[1]{\phantomsection\addcontentsline{toc}{section}{#1}}
\newcommand{\nonumsubsection}[1]{\phantomsection\addcontentsline{toc}{subsection}{#1}}
\newcommand{\nonumsubsubsection}[1]{\phantomsection\addcontentsline{toc}{subsubsection}{#1}}

% Draft mode [[[2
%\renewcommand{\showlabelfont}{\tiny\ttfamily}
%\showlabels{cite}
%\showlabels{ref}
%\showlabels{begin}

\newcounter{todonotecounter}
\NewDocumentCommand \margintodo {s o m} 
  {
    \stepcounter{todonotecounter}
    \IfBooleanTF{#1}{}{%
      \marginpar{%
        \IfValueT{#2}{\vspace{#2}}%
        \raggedoutside
        \footnotesize%
        \fcolorbox{red}{white}{\color{red} \thetodonotecounter}%
        #3%
      }
    }
  }


% Math [[[2
\IfDocTypeTF{book}
  {\numberwithin{equation}{chapter}}
  {\numberwithin{equation}{section}}

%\MathStyle
%  {
%    integrate/displayfunc=outset,
%    vecdisplay=bold,
%  }

% TODO: remember to set locale correctly!!
%\sisetup{%
%  separate-uncertainty=true,
%  %locale = DE,
%  %per-mode = symbol
%}

% vim: ts=2 sw=2 et fdm=marker fmr=[[[,]]]:
