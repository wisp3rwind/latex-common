% This file should only contain things that can go into any kind of document.

% TODO: keyvals: draft (obvious), debug (load blind text packages), strict (whether to fail or fallback, e.g. for luatex-only features like specific fonts)
% TODO: math: automatically replace i/j i/jmath (have an option to prevent that)
% TODO: support passing style options to most of the commands, 
%       e.g. \vc[vecdisplay=bm]{x}
% TODO: 'features' that bundle packages + additional commands/configuration
% -> fonts are nothing but features!
% TODO: append code to package setup (independent of enabling)
% TODO: engine-specific features, engine={luatex,xetex}

% New packages to investigate
% subfigure
% geometry
% pdfpages
% cite  % better support for numeric citations
% longtable  % wrap tables at page boundaries, succeeds supertabular
% supertabular  % wrap tables at page boundaries
% wrapfig
% footmisc
% epstopdf
% textcomp
% marginnote


%\mhchemoptions{textfontcommand=\liningnumtext}
%\IfPresentationT{\renewcommand*{\bibfont}{\scriptsize}}

% TODO: remember to set locale correctly!!
%\sisetup{%
%  separate-uncertainty=true,
%  %locale = DE,
%  %per-mode = symbol
%}


% Early packages loads required for handling the configuration [[[1
\RequirePackage{xparse}  % includes the l3 kernel

\ExplSyntaxOn

% Variants [[[1
\cs_generate_variant:Nn \clist_use:Nn {nn}
\cs_generate_variant:Nn \prop_get:cnN { cvN }
\cs_new_eq:NN \__wisper_pass_options_to_package:nn \PassOptionsToPackage
\cs_generate_variant:Nn \__wisper_pass_options_to_package:nn { Vn }
\cs_generate_variant:Nn \bool_not_p:n { v }
\cs_generate_variant:Nn \bool_if_p:n { v }
\cs_generate_variant:Nn \keyval_parse:NNn { NNv }
\cs_generate_variant:Nn \msg_error:nnnn { nnnx }

% Debugging helpers [[[1
\clist_new:N \g__wisper_debug_modules_clist
\clist_gset:Nn \g__wisper_debug_modules_clist {} % { loader, declaration }
\prg_new_conditional:Nnn \__wisper_if_debug:n { T, F, TF }
  { 
    \clist_if_in:NnTF \g__wisper_debug_modules_clist {#1}
      { \prg_return_true: }
      { \prg_return_false: }
  }

% Common messages [[[1
\msg_new:nnn { wisper } { unknown-choice }
  { Unknown~#1~'#2'.~Valid~choices~are~\clist_use:nn{#3}{,~}. }
\msg_new:nnn { wisper } { check-loading-feature }
  { Checking~whether~to~load~feature~'#1'. }
\msg_new:nnn { wisper } { loading-feature }
  { Loading~feature~'#1'. }
\msg_new:nnn { wisper } { no-such-feature-option }
  { No~such~option~('#2')~for~feature~'#1'. }

% Common helper functions for package and document class loading [[[1
% Helper function to get the square brackets for passing optional arguments.
\cs_new:Npn \__wisper_load_with_optional_arg_aux:Nnn #1#2#3
  {
    #1[#2]{#3}
  }

% Helper function to transform the class option property list into a clist.
\cs_new:Npn \__wisper_build_clist_from_prop:NN #1#2
  {
    \__wisper_if_debug:nT { loader }
      { \prop_show:N #1 }

    \prop_map_inline:Nn #1
      {
        \clist_put_right:Nx #2
          {
            \str_if_eq:nnTF {##2} {}
              {##1,}
              {##1=##2,}
          }
      }
  }

\cs_new:Npn \__wisper_load_with_optional_arg:NNn #1#2#3
  {
    \clist_clear:N \l__tmpa_clist
    \__wisper_build_clist_from_prop:NN #2 \l__tmpa_clist
    \__wisper_if_debug:nT { loader }
      {
        \clist_show:N \l__tmpa_clist
        \str_show:n {#3}
      }
    \exp_args:Noo \__wisper_load_with_optional_arg_aux:Nnn #1
      {
        \clist_use:Nn \l__tmpa_clist { ,~ }
      }
      { #3 }
  }
\cs_generate_variant:Nn \__wisper_load_with_optional_arg:NNn { NNV, Ncn}

% string list conditional, code is very similar to \__prop_if_in
\prg_new_conditional:Npnn \__strlist_if_in:nn #1#2 { p, T, F, TF }
  {
    \__strlist_if_in:nww { #2 } #1 , #2 , \q_recursion_tail
    \__prg_break_point:
  }
\cs_new:Npn \__strlist_if_in:nww #1 #2 ,
  {
    \str_if_eq:nnTF {#1} {#2}
      { \__strlist_if_in:N }
      { \__strlist_if_in:nww {#1} }
  }
\cs_new:Npn \__strlist_if_in:N #1
  {
    \if_meaning:w \q_recursion_tail #1
      \prg_return_false:
    \else:
      \prg_return_true:
    \fi:
    \__prg_break:
  }
\cs_generate_variant:Nn \__strlist_if_in:nnTF { nVTF }
\cs_generate_variant:Nn \__strlist_if_in_p:nn { nV }

\prg_new_conditional:Npnn \__wisper_if_engine:n #1 { p, T, F, TF }
  {
    \__strlist_if_in:nVTF {#1} \c_sys_engine_str
    %\clist_if_in:nVTF {#1} \c_sys_engine_str
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \__wisper_if_engine:nTF { vTF }
\cs_generate_variant:Nn \__wisper_if_engine_p:n { v }

% Code mostly borrowed from \__str_case:nnTF
\cs_new:Npn \__wisper_switch_engine:n #1
  {
    \exp:w
    \__wisper_switch_engine_aux:nTF {#1} { } { }
  }
\cs_new:Npn \__wisper_switch_engine:nT #1#2
  {
    \exp:w
    \__wisper_switch_engine_aux:nTF {#1} {#2} { }
  }
\cs_new:Npn \__wisper_switch_engine:nF #1
  {
    \exp:w
    \__wisper_switch_engine_aux:nTF {#1} { }
  }
\cs_new:Npn \__wisper_switch_engine:nTF #1
  {
    \exp:w
    \__wisper_switch_engine_aux:nTF {#1}
  }

\cs_new:Npn \__wisper_switch_engine_aux:nTF #1#2#3
  { \__wisper_switch_engine_aux:VnTF \c_sys_engine_str {#1} {#2} {#3} }
\cs_new:Npn \__wisper_switch_engine_aux:nnTF #1#2#3#4
  { \__wisper_switch_engine:nw {#1} #2 {#1} { } \q_mark {#3} \q_mark {#4} \q_stop }
\cs_generate_variant:Nn \__wisper_switch_engine_aux:nnTF { VnTF }

\cs_new:Npn \__wisper_switch_engine:nw #1#2#3
  {
    \__strlist_if_in:nnTF {#2} {#1}
      { \__prg_case_end:nw {#3} }
      { \__wisper_switch_engine:nw {#1} }
  }

% Convenience funtions for the key-value interface [[[1
\cs_new:Npn \__wisper_keys_define:n #1 { \keys_define:nn { wisper } {#1} }

\cs_new:Npn \__wisper_keys_define_internal:n #1 { \keys_define:nn { wisper/internal } {#1} }
\cs_new:Npn \__wisper_keys_define_doc:n #1 { \keys_define:nn { wisper/document } {#1} }
\cs_new:Npn \__wisper_keys_define_doc:nn #1#2 { \keys_define:nn { wisper/document/#1 } {#2} }

\cs_new:Npn \__wisper_keys_set_internal:n #1 { \keys_set:nn { wisper/internal } {#1} }
\cs_new:Npn \__wisper_keys_set_doc:n #1 { \keys_set:nn { wisper/document } {#1} }
\cs_new:Npn \__wisper_keys_set_doc:nn #1#2 { \keys_set:nn { wisper/document/#1 } {#2} }

% User-accessible aliases.
\cs_new_eq:NN \DocumentStyle \__wisper_keys_set_doc:n

% Document class handling [[[1

% Global storage for class name and options.
\str_new:N \g__wisper_classname_str
\prop_new:N \g__wisper_classopts_prop

% Document class loader.   [[[2
\cs_new:Nn \__wisper_load_document_class:
  {
    \__wisper_load_with_optional_arg:NNV
      \documentclass
      \g__wisper_classopts_prop
      \g__wisper_classname_str
  }

% Conditional for the document class.   [[[2
\prg_new_conditional:Npnn \__wisper_if_document_class:n #1 { p, T, F, TF}
  { 
    \str_if_eq:nnTF {#1} {koma}
      {
        % koma is an alias for any KOMA-script class
        \__wisper_if_document_class:nTF { scrartcl, scrbook, scrreprt, scrlttr2 }
           { \prg_return_true: } { \prg_return_false: }
      }
      {
        \__strlist_if_in:nVTF {#1} \g__wisper_classname_str 
           { \prg_return_true: } { \prg_return_false: }
      }
  }
\cs_generate_variant:Nn \__wisper_if_document_class:nTF { vTF }
\cs_generate_variant:Nn \__wisper_if_document_class_p:n { v }

\cs_new:Npn \__wisper_prop_keys_to_clist:NN #1#2
  {
    \clist_clear:N #2
    \prop_map_inline:Nn #1 { \clist_put_right:Nn #2 {##1} }
  }
\cs_generate_variant:Nn \__wisper_prop_keys_to_clist:NN { cN }

% TODO: require values for paper, roman/sans, languages, landscape, tocdepth, type. Or somehow
% support default values?
% -> Ensure that all keys can be set multiple times without issues.

% Key-value interface to pre-defined document layouts ('document types'). [[[2
\__wisper_keys_define_doc:n
  {
    paper .choices:nn =
      { a4paper, a5paper }
      {
        \prop_put:NnV \g__wisper_classopts_prop {paper} \l_keys_choice_tl
      },
    paper / unknown .code:n =
      {
        \msg_error:nnnnn { wisper } { unknown-choice }
          { paper~format }
          {#1}
          { a4paper, a5paper} % TODO: Don't hardcode
      },
    languages .code:n =
      {
        \clist_map_inline:nn {#1}
          { \prop_put:Nnn \g__wisper_classopts_prop {##1} {} }
      },
    main_language .code:n =
      {
        \__wisper_pass_options_to_package:nn {main=#1} {babel} 
        %\prop_put:Nnn \g__wisper_classopts_prop {#1} {}
      },

    languages .initial:n = {english},

    %landscape .bool:,

    type .choice:,
    type / article .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {article}
        \str_set:Nn \g__wisper_classname_str {article}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
      },
    type / presentation .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {presentation}
        \str_set:Nn \g__wisper_classname_str {beamer}
      },
    type / letter .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {letter}
        \str_set:Nn \g__wisper_classname_str {scrlttr2}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
        \__wisper_enable_features:n { koma-misc }
      },
    type / book .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {book}
        \str_set:Nn \g__wisper_classname_str {book}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
      },
    type / scrbook .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {scrbook}
        \str_set:Nn \g__wisper_classname_str {scrbook}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
        \prop_put:Nnn \g__wisper_classopts_prop {BCOR} {0mm}
        \prop_put:Nnn \g__wisper_classopts_prop {DIV} {10}
        \prop_put:Nnn \g__wisper_classopts_prop {pagesize} {}
        \__wisper_enable_features:n { koma-misc }
      },
    type / scrartcl .code:n =
      {
        \str_set:Nn \g__wisper_document_type_str {scrartcl}
        \str_set:Nn \g__wisper_classname_str {scrartcl}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
        \prop_put:Nnn \g__wisper_classopts_prop {BCOR} {0mm}
        \prop_put:Nnn \g__wisper_classopts_prop {DIV} {10}
        \prop_put:Nnn \g__wisper_classopts_prop {pagesize} {}
        \__wisper_enable_features:n { koma-misc }
      },

    type / exercise .code:n =
      {
        \__wisper_keys_set_doc:n {type/scrartcl}
        \str_set:Nn \g__wisper_document_type_str {exercise}
        \__wisper_enable_features:n
          {
            font-TexGyre,
            math,
            phys,
          }
      },

    type / unknown .code:n =
      {
        \msg_error:nnnnn { wisper } { unknown-choice }
          { document~type }
          {#1}
          { article, presentation, letter, book, scrbook } % TODO: Don't hardcode
      },
  }

% Conditionals [[[2
\prg_new_conditional:Npnn \__wisper_if_document_type:n #1
  { p, T, F, TF}
  { 
    \clist_if_in:nVTF {#1} \g__wisper_document_type_str
      { \prg_return_true: }
      { \prg_return_false: }
  }

% User-accessible aliases.
\cs_new_eq:NN \IfDocTypeT \__wisper_if_document_type:nT
\cs_new_eq:NN \IfDocTypeF \__wisper_if_document_type:nF
\cs_new_eq:NN \IfDocTypeTF \__wisper_if_document_type:nTF

\cs_new_eq:NN \IfDocClassT \__wisper_if_document_class:nT
\cs_new_eq:NN \IfDocClassF \__wisper_if_document_class:nF
\cs_new_eq:NN \IfDocClassTF \__wisper_if_document_class:nTF

% Features [[[1
\prop_new:N \g__wisper_feature_features_prop
\prop_new:N \g__wisper_feature_code_prop
\tl_new:N \g__wisper_feature_code_tl

% #1 - name
% #2 - keyvals
% #3 - code
\cs_new:Npn \__wisper_declare_feature_aux:nnn #1#2#3
  {
    \cs_if_exist:cF {g__wisper_feature_ #1 _enabled_bool}
      { \bool_gset_false:c {g__wisper_feature_ #1 _enabled_bool} }
    \bool_gset_false:c {g__wisper_feature_ #1 _loaded_bool}
    \clist_new:c {g__wisper_feature_ #1 _features_clist}
    \tl_gset:cn {g__wisper_feature_ #1 _code_tl} {#3}

    \__wisper_keys_define_doc:n
      {
        %features/#1/enabled .bool_gset:c = {g__wisper_package_ #1 _enabled_bool},
        %features/#1/enabled .default:n = true,
        features/#1/enabled .code:n = 
          { \__wisper_enable_feature:n {#1} },
        features/#1/enabled .value_forbidden:n = true,
        %features/#1/disabled .bool_gset_inverse:c = {g__wisper_package_ #1 _enabled_bool},
        %features/#1/disabled .default:n = true,
        features/#1/disabled .code:n = 
          { },
        features/#1/disabled .value_forbidden:n = true,

        features/#1/requires .clist_gset:c = {g__wisper_feature_ #1 _features_clist},

        features/#1/options / unknown .code:n =
          { \msg_error:nnnx { wisper } { no-such-feature-option } {#1} {\l_keys_key_tl=##1} },

        features/#1/conflicts / classes .tl_gset:c = {g__wisper_feature_ #1 _conflicting_classes_tl},
        features/#1/conflicts / features .tl_gset:c = {g__wisper_feature_ #1 _conflicting_features_tl},
        features/#1/conflicts / classes .initial:n = {},
        features/#1/conflicts / features .initial:n = {},

        % e.g. document classes can prevent loading a feature, should raise an
        % error if enabled explicitly in some place.
        features/#1/deactivate .bool_gset:c = {g__wisper_feature_ #1 _deactivated_bool},
        features/#1/deactivate_for_engines .tl_gset:c = {g__wisper_feature_ #1 _deactivated_for_engines_strlist},
        features/#1/deactivate_for_engines .initial:n = {},
        features/#1/deactivate_for_classes .tl_gset:c = {g__wisper_feature_ #1 _deactivated_for_classes_strlist},
        features/#1/deactivate_for_classes .initial:n = {},
      }

      \__wisper_set_feature_config:nn {#1} {#2}
  }

\cs_new:Npn \__wisper_set_feature_config:nn #1#2
  { \__wisper_keys_set_doc:nn { features/#1 } {#2} }
\cs_new:Npn \__wisper_set_feature_config:nnn #1#2#3
  { \__wisper_keys_set_doc:nn { features/#1/#2 } {#3} }

\cs_new:Npn \__wisper_enable_feature_set_options:nn #1#2
  {
    \__wisper_enable_feature:n {#1}
    \__wisper_set_feature_config:nn {#1}  {options={#2}}
  }

\cs_new:Npn \__wisper_enable_feature:n #1
  {
    \bool_if:cF {g__wisper_feature_ #1 _enabled_bool}
      {
        \bool_gset_true:c {g__wisper_feature_ #1 _enabled_bool}
        %\tl_show:c {g__wisper_feature_ #1 _features_clist}
        \keyval_parse:NNv
          \__wisper_enable_feature:n
          \__wisper_enable_feature_set_options:nn
          {g__wisper_feature_ #1 _features_clist}
      }
  }
\cs_new:Npn \__wisper_enable_features:n #1
  {
    \clist_map_function:nN {#1} \__wisper_enable_feature:n
  }
\msg_new:nnn { wisper } { feature-executing } { Executing~feature-code~'#1'. }
\cs_new:Nn \__wisper_load_features: 
  {
    \prop_map_inline:Nn \g__wisper_feature_code_prop
      {
        \__wisper_if_debug:nT { features }
          { \msg_warning:nnn { wisper } { feature-executing } {##1} }
        \use:n {##2}
      }
  }

\cs_new:Npn \__wisper_declare_mutually_exclusive_features:n #1
  {
    % TODO: implement
  }

% "Normal" features [[[2
\seq_new:N \g__wisper_all_features_main_seq
\cs_new:Npn \__wisper_declare_feature:nnn #1#2#3
  {
    \seq_put_right:Nn \g__wisper_all_features_main_seq {#1}
    \__wisper_declare_feature_aux:nnn {#1} {#2} {#3}
  }
\cs_generate_variant:Nn \bool_show:n { x }

% Feature loading [[[2
\prg_new_conditional:Npnn \__wisper_should_load_feature:n #1 { T, F, TF }
  {
    %\bool_show:x { \bool_not_p:v {g__wisper_feature_ #1 _enabled_bool} }
    %\bool_show:x { \bool_if_p:v {g__wisper_feature_ #1 _loaded_bool} }
    %\bool_show:x { \__wisper_if_engine_p:v {g__wisper_feature_ #1 _deactivated_for_engines_strlist} }
    %\bool_show:x { \__wisper_if_document_class_p:v {g__wisper_feature_ #1 _deactivated_for_classes_strlist} }
    \bool_lazy_any:nTF
      {
        { \bool_not_p:v {g__wisper_feature_ #1 _enabled_bool} }
        { \bool_if_p:v {g__wisper_feature_ #1 _loaded_bool} }
        { \__wisper_if_engine_p:v {g__wisper_feature_ #1 _deactivated_for_engines_strlist} }
        { \__wisper_if_document_class_p:v {g__wisper_feature_ #1 _deactivated_for_classes_strlist} }
      }
      { \prg_return_false: } { \prg_return_true: }
  }
\cs_new:Npn \__wisper_load_feature:n #1
  {
    \msg_warning:nnn { wisper } { check-loading-feature } {#1}
    \__wisper_should_load_feature:nT {#1}
      {
        \msg_warning:nnn { wisper } { loading-feature } {#1}
        \bool_gset_true:c {g__wisper_feature_ #1 _loaded_bool}
        \use:c {g__wisper_feature_ #1 _code_tl}
      }
  }
\cs_new:Npn \__wisper_load_features:n #1
  {
    \clist_map_inline:cn {g__wisper_all_features_ #1 _clist}
      { \__wisper_load_feature:n {##1} }
  }

% Special case features: fonts [[[2
%\seq_new:N \g__wisper_all_features_font_seq
\clist_new:N \g__wisper_all_features_font_clist
\cs_new:Npn \__wisper_declare_font:nnn #1#2#3
  {
    %\seq_put_right:Nn \g__wisper_all_features_font_seq {#1}
    \clist_put_right:Nn \g__wisper_all_features_font_clist {#1}
    \__wisper_declare_feature_aux:nnn {#1} {#2} {#3}
  }
% Special case features: packages [[[2
\seq_new:N \g__wisper_all_features_packages_seq
\cs_new:Npn \__wisper_declare_package:nnn #1#2#3
  {
    \seq_put_right:Nn \g__wisper_all_features_packages_seq {#1}
    \__wisper_keys_define_doc:n
      {
        features/#1/options .code:n =
          { \__wisper_pass_options_to_package:nn {##1} {#1} },
      }
    \__wisper_declare_feature_aux:nnn {#1} {#2}
      {
        \usepackage{#1}
        #3
      }
  }
\cs_new:Npn \__wisper_declare_package:nn #1#2
  { \__wisper_declare_package:nnn {#1} {#2} {} }
\cs_new:Npn \__wisper_declare_package:n #1
  { \__wisper_declare_package:nnn {#1} {} {} }
\cs_new:Npn \__wisper_declare_packages:n #1
  {
    \keyval_parse:NNn
      \__wisper_declare_package:n
      \__wisper_declare_package:nn
      {#1}
  }

% Feature declarations [[[1
% TODO: package option presets!

% Fonts [[[2
% Packages [[[
\__wisper_declare_packages:n
  {
    % These packages are not supposed to be loaded in
    % \__wisper_load_features:n { main },
    % but manually in \__wisper_load_features:n { font }
    newpxmath,
    fontspec,
    newpxtext,
    lmodern,
    FiraSans,
    FiraMono,
    mathdesign,
    mathpazo,
  }  % ]]]
\__wisper_declare_font:nnn { font-lmodern }  % [[[
  {
    requires = lmodern,
  }
  {
    \__wisper_load_package:n { lmodern }
  }  % ]]]
\__wisper_declare_font:nnn { font-fira }  % [[[
  {
    requires = {
      FiraMono,
      FiraSans = sfdefault,
    },
  }
  {
    % Mozilla Fira Sans, requires XeLaTeX or LuaLaTex TODO: raise error
    \__wisper_load_package:n {FiraSans}
    \__wisper_load_package:n {FiraMono}
  }  % ]]]
\__wisper_declare_font:nnn { font-garamond }  % [[[
  {
    requires = {
      mathdesign = urw-garamond,
    },
  }
  {
    % URW-Garamond: A free garamond font, supposedly good for books but to
    % fragile for presentations. Math fonts provided by the mathdesign project
    % FIXME: maybe drop this? PagellaX is better anyway. At least give a
    % warning.
    % TODO: matching sans font
    \__wisper_load_package:n {mathdesign}
  }  % ]]]
\__wisper_declare_font:nnn { font-palatino }  % [[[
  {
    requires = {
      mathpazo = osf,
    },
  }
  {
    \__wisper_load_package:n {mathpazo}
  }  % ]]]
\__wisper_declare_font:nnn { font-TexGyre }  % [[[
  {
    requires = {
      amsthm,
      newpxtext = largesc,
      newpxmath = vvarbb,
      fontspec = no-math,
    },
  }
  {
    % preload amsthm to suppress error due to newpxmath redfining \openbox
    \__wisper_load_feature:n {amsthm}
    \__wisper_load_feature:n {newpxmath}

    \__wisper_switch_engine:nF
      {
        { luatex }
          {
            \__wisper_load_feature:n {fontspec}
            % TODO: ensure correct small caps, \usepackage[largesc]{newpxtext}
            % (but the package isn't loaded here...)
            \setmainfont{TeXGyrePagellaX}[Numbers=OldStyle]
            \setsansfont{TeXGyreHeros}
            % TODO: where appropriate, check for \liningnumtext to be defined and
            % use it.
            \newfontfamily\liningnumtext{TeXGyrePagellaX}[Numbers=Lining]
          }
        { xetex }
          {
            \PackageError{---}{No~XeTeX~support~here.}
          }
      }
      {
        % Other TeX
        \__wisper_load_feature:n {newpxtext}
        \useosf
      }

      \linespread{1.05}
    }  % ]]]


% Generic [[[2
\__wisper_declare_packages:n
  {
    enumitem = {
      enabled,
      options = { inline },
      % doesn't play well with overlay specifications
      deactivate_for_classes = { beamer },
    },
    calc = enabled,
    ragged2e = enabled,
    xcolor = enabled,
    url = {
      enabled,
      options = { hyphens },
      % loaded early by hyperref which is loaded way to early by beamer...
      % loading it again gives an option clash.
      deactivate_for_classes = { beamer },
    },
    hyperref = enabled,
    sidenotes,
    %babel = { enabled, options = { main=english } },
    babel = { enabled },
    fontenc = { enabled, options = { T1 } },
    csquotes = enabled,
    microtype = enabled,
    inputenc = {
      enabled,
      options = { utf8 },
      % Suppress inputenc warning for utf8 engines
      deactivate_for_engines = { luatex, xetex },
    },
    fancyhdr,
    amsthm,
  }

\__wisper_declare_feature:nnn { nonnum-section-commands }
  {}
  {
    % unnumbered section that shows up in the TOC
    \newcommand{\tocsection}[1]{\section*{#1}\addcontentsline{toc}{section}{#1}}
    % non-numbered subsection that works properly with hyperref
    \IfDocClassT { book, scrbook }
      { \newcommand{\nonumchapter}[1]{\phantomsection\addcontentsline{toc}{chapter}{#1}} }
    \newcommand{\nonumsection}[1]{\phantomsection\addcontentsline{toc}{section}{#1}}
    \newcommand{\nonumsubsection}[1]{\phantomsection\addcontentsline{toc}{subsection}{#1}}
    \newcommand{\nonumsubsubsection}[1]{\phantomsection\addcontentsline{toc}{subsubsection}{#1}}
  }

% Colors  [[[2
\__wisper_declare_feature:nnn {sron-mark-colors}
  { requires = xcolor }
  {
    % define a few highlighting colors, from https://personal.sron.nl/~pault/
    \definecolor{marklightblue}{HTML}{BBCCEE}
    \definecolor{marklightteal}{HTML}{CCEEFF}
    \definecolor{marklightgreen}{HTML}{CCDDAA}
    \definecolor{marklightsand}{HTML}{EEEEBB}
    \definecolor{marklightred}{HTML}{FFCCCC}
    \definecolor{markdarkblue}{HTML}{222255}
    \definecolor{markdarkteal}{HTML}{225555}
    \definecolor{markdarkgreen}{HTML}{225522}
    \definecolor{markdarksand}{HTML}{666633}
    \definecolor{markdarkred}{HTML}{663333}
  }

% Bibliography [[[2
\__wisper_keys_define_doc:n
  {
    cite/style .choice:,
    cite/style/super .meta:n = {},
    cite/style/bracket .meta:n = {},

    cite/enable~footnote .meta:n =
      {
        footnotes/multiple = true,
      },
  }

\__wisper_declare_package:nn { biblatex }
  {
    disabled,
    options = { hyperref=true },
  }

\__wisper_declare_feature:nnn { biblatex-backref } {}
  {
    disabled,
    requires = {
      biblatex = {
        backref=true,
      },
    },
  }

\__wisper_declare_feature:nnn { biblatex-default-verbosity } {}
  {
    disabled,
    requires = {
      biblatex = {
        url=false,
        isbn=false,%  DOI only
        maxcitenames=3,
        maxbibnames=3,
        citereset=section,
      },
    },
  }

\__wisper_declare_feature:nnn { biblatex-alphabetic } {}
  {
    disabled,
    requires = {
      biblatex = {
        % many of these options can only be given in \usepackage and not later, unfortunately..
        style=alphabetic,
      },
      biblatex-backref,
      biblatex-default-verbosity,
    },
  }

\__wisper_declare_feature:nnn { biblatex-numeric-supercite } {}
  {
    disabled,
    requires = {
      biblatex = {
        %bibstyle=authoryear,
        bibstyle=numeric,
        citestyle=custom-numeric-comp,
        %citestyle=numeric-comp,
      },
      biblatex-backref,
      biblatex-default-verbosity,
    },
  }

\__wisper_declare_feature:nnn { biblatex-alphabetic-supercite } {}
  {
    % FIXME: implement
  }

\__wisper_declare_feature:nnn {footnotecite}
  { requires = multiple-footnotes }
  {
    \DeclareNewFootnote{Cite}
  }

\__wisper_declare_feature:nnn { supershortnotecite }
  {}
  {
    % From http://www.khirevich.com/latex/footnote_citation/
    % new command \sjcitep prints footnote citation above punctuation
    \newlength{\spc} % declare a variable to save spacing value
    % TODO: ensure that this works when there are non-cite footnotes on the same page
    \NewDocumentCommand{\citep}{D<>{} o o m}{% new command with two arguments: optional (#1) and mandatory (#2)
            \settowidth{\spc}{#1}% set value of \spc variable to the width of #1 argument
            \addtolength{\spc}{-1.8\spc}% subtract from \spc about two (1.8) of its values making its magnitude negative
            #1% print the optional argument
            \hspace*{\spc}% print an additional negative spacing stored in \spc after #1
            \IfNoValueTF{#2}
                {\supershortnotecite{#4}}
                {\IfNoValueTF{#3}
                    {\supershortnotecite[#2]{#4}}
                    {\supershortnotecite[#2][#3]{#4}}}
        }% print (cite) the mandatory argument
  }



% Page-layout: one-/twoside etc [[[2
\__wisper_declare_packages:n
  { changepage }

\__wisper_declare_feature:nnn { oneside }
  % This feature mostly exists to provide dummy commands for justification etc.
  % so that twoside documents can easily be compiled onesided.
  {
    enabled,
  }
  {
    \cs_new_eq:NN \raggedoutside \raggedright
    \NewDocumentEnvironment {flushinside} {}
      { \bgroup \flushleft }
      { \egroup }
  }
\__wisper_declare_feature:nnn { twoside } {}
  {
    disabled,
    classoptions = { twoside },
    requires = {
      changepage = strict,
    },
  }
  {
    \cs_new:Npn \raggedoutside
      {
        \checkoddpage
        \ifoddpage
          \RaggedRight
        \else
          \RaggedLeft
        \fi
      }
    \NewDocumentEnvironment {flushinside} {}
      {
        \checkoddpage
        \bgroup
        \ifoddpage
          \flushleft
        \else
          \flushright
        \fi
      }
      {
        \egroup
      }
  }
\__wisper_declare_mutually_exclusive_features:n { oneside, twoside }

% Layout for KOMA [[[
\__wisper_declare_feature:nnn { koma-misc }
  {}
  {
    \IfDocClassT{koma}
      {
        % TODO: make the use of boldmath configurable, cf. 
        % https://tex.stackexchange.com/questions/108894/typesetting-formulas-in-section-titles-title-bold-toc-entry-isnt#comment238645_108894
        % https://tex.stackexchange.com/questions/41379/automatically-typeset-math-in-section-headings-in-bold-face#124311
        % Fix chapter/section titles defaulting to sans (i.e. CM) fonts
        \setkomafont{disposition}{\normalfont\bfseries\boldmath}
        \KOMAoptions{headings=normal}
        % Fix fonts in the toc
        \IfDocClassT {scrbook}
          { \setkomafont{chapterentry}{\normalfont\bfseries\boldmath} }
        % fix item font in descriptions and enumerates
        \setkomafont{descriptionlabel}{\normalfont\bfseries\boldmath}
        \setkomafont{labelinglabel}{\normalfont\bfseries\boldmath}
        % Suppress warnings on font fallback
        \renewcommand\labelitemi{{\fontfamily{cmr}\selectfont\textbullet}}
        \renewcommand\labelitemiii{{\fontfamily{cmr}\selectfont\textasteriskcentered}}
        \renewcommand\labelitemiv{{\fontfamily{cmr}\selectfont\textperiodcentered}}
        
        % Titlepage
        \IfDocTypeT { scrbook }
          { \KOMAoptions{titlepage=firstiscover} }
        
        % Footnotes
        \KOMAoptions{footnotes=multiple}  % comma-separate footnote superscripts
        \renewcommand{\multfootsep}{,}
        
        % Header/Footer
        \usepackage[draft=false]{scrlayer-scrpage}
        \pagestyle{scrheadings}
        \IfDocTypeT { scrbook }
          { \automark[chapter]{chapter} }
        \automark*[section]{}
        \ihead{}
        \chead{\headmark}
        \ohead{\pagemark}
        \ifoot{}
        \cfoot{}
        \ofoot{}
        %\KOMAoptions{headsepline=true}
        %\KOMAoptions{footsepline=:0.5\textwidth, olines}
      }
    }  % ]]]

% Tufte-style
\__wisper_keys_define_doc:n
  {
    tufte .meta:n =
      {
        cite/style = super,
        cite/enable~footnote,
      },

    internal/load~sidenotes .code:n = {},
    sidenotes/enable .meta:n =
      {
        internal/load~sidenotes .code:n =
          {
            \__wisper_if_document_type:nT {book, scrbook}
              { \usepackage{sidenotes} }
          }
      },
  }

% Footnotes [[[2
\__wisper_declare_package:n { bigfoot }

\bool_new:N \g__wisper_footnotes_multiple_bool
\__wisper_keys_define_doc:n
  {
    footnotes/multiple .bool_gset:N = \g__wisper_footnotes_multiple_bool,
  }

\__wisper_declare_feature:nnn { alphabetic-default-footnote }
  {
    requires = { bigfoot },
  }
  {
    \__wisper_if_feature_enabled:n { bigfoot }
      {
        \DeclareNewFootnote{default}[alph]
        \cs_gset_eq:NN \footnote \footnotedefault
        \cs_gset_eq:NN \footnotemark \footnotemarkdefault
        \cs_gset_eq:NN \footnotetext \footnotetextdefault
      }
      {
        \cs_gset:Nn \thefootnote { \alph{footnote} }
      }
  }

% Hyperref [[[2
\__wisper_declare_feature:nnn { hyperref-bookmarks-default } {}
  {
    enabled,
    requires = {
      hyperref = {
        bookmarksopen=true,
        bookmarksopenlevel=3,
      }
    },
  }
\__wisper_declare_feature:nnn { hyperref-black } {}
  {
    requires = {
      hyperref = {
        hidelinks,
      }
    },
  }
\__wisper_declare_feature:nnn { hyperref-pale-colors } {}
  {
    enabled,
    requires = {
      hyperref = {
        % TODO: this required another package!
        colorlinks=true,
        linkcolor=black,  % for internal links, color is just too much
        citecolor=markdarkteal,
        filecolor=markdarkgreen,
        urlcolor=markdarkblue,
      }
    },
  }
\__wisper_declare_mutually_exclusive_features:n
  { hyperref-black, hyperref-pale-colors }

% Code display [[[2
\__wisper_declare_packages:n
  { minted }

\__wisper_declare_feature:nnn { minted-default }
  {
    requires = { minted },
  }
  {
    \input{common_code.tex}
  }

\__wisper_declare_feature:nnn { listings }
  { requires = minted }
  {
  }

% Math, physics [[[2
\__wisper_declare_feature:nnn { math }
  {}
  {
    \input{common_math.tex}
    \MathStyle
      {
        integrate/displayfunc=outset,
        vecdisplay=bold,
      }
  }

\__wisper_declare_feature:nnn { phys }
  {}
  {
    \input{common_phys.tex}
  }

% Tables, figures [[[2
\__wisper_declare_packages:n
  {
    float = enabled,
    rotating = enabled,
    booktabs = enabled,
    array = enabled,
    multirow,
    tabu,
    caption = enabled,
    subcaption = enabled,
    graphicx = enabled,
  }

\__wisper_declare_feature:nnn {array-par-columns}
  { requires = array }
  {
    % https://tex.stackexchange.com/a/2442/111880
    % https://tex.stackexchange.com/a/12712/111880
    \newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
    \newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
    \newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
  }

\__wisper_declare_feature:nnn { twoside-floats }
  { requires = caption }
  {
    \DeclareCaptionStyle{myfigure}{font=footnotesize,%
                                   labelfont=sc,%
                                   }
    \captionsetup{style=myfigure}  % default

    % TODO: as for changepage: better conditional, cf. above
    \__wisper_if_document_type:nT {book, scrbook}
      {
        \DeclareCaptionJustification{raggedoutside}{\raggedoutside}

        \DeclareCaptionStyle{marginfigure}{justification=raggedoutside,%
                                           font=footnotesize,%
                                           labelfont=sc,%
                                           }

        \DeclareCaptionStyle{margintable}{justification=raggedoutside,%
                                          font=footnotesize,%
                                          labelfont=sc,%
                                          }

        \DeclareCaptionStyle{sidecaption}{justification=raggedoutside,%
                                          font=footnotesize,%
                                          labelfont=sc,%
                                          }
        \newlength{\realmarginparwidth}
        \setlength{\realmarginparwidth}{\marginparwidth}
        \addtolength{\realmarginparwidth}{\marginparsep}

        \DeclareCaptionStyle{widetable}{%justification=raggedoutside,%
                                        font=footnotesize,%
                                        labelfont=sc,%
                                        margin={0pt, \realmarginparwidth}
                                        }
      }
  }

% Drafts [[[2

\__wisper_declare_package:nnn { showlabels }
  { options = inner }
  {
    \renewcommand{\showlabelfont}{\tiny\ttfamily}
    \showlabels{cite}
    \showlabels{ref}
    \showlabels{begin}
  }

\__wisper_declare_feature:nnn { draft-tools }
  {}
  {
    \newcounter{todonotecounter}
    \NewDocumentCommand \margintodo {s o m} 
      {
        \stepcounter{todonotecounter}
        \IfBooleanTF{#1}{}{%
          \marginpar{%
            \IfValueT{#2}{\vspace{#2}}%
            \raggedoutside
            \footnotesize%
            \fcolorbox{red}{white}{\color{red} \thetodonotecounter}%
            #3%
          }
        }
      }
  }

% Loading orders [[[1

% TODO: automatically set these clists from \__wisper_declare_feature:
\clist_gset:Nn \g__wisper_all_features_early_packages_clist
  {
    inputenc,
    babel,
    fontenc,
  }
\clist_gset:Nn \g__wisper_all_features_main_packages_clist
  {
    koma-misc,

    % load minted before csquotes to suppress a warning due to a common package
    % they load
    minted,
    csquotes,  % context-sensitive quotes
    microtype,

    sidenotes,

    enumitem,
    float,
    calc,
    fancyhdr,
    ragged2e,
    url,

    % colors
    xcolor,

    % tables
    rotating,
    booktabs,
    array,
    multirow,
    tabu,

    % Graphics
    graphicx,  % advanced key=value arguments for \includegraphics
    caption,
    subcaption,

    biblatex,

    phys,
    math,


    % Packages that need to be loaded last [[[2
    bigfoot,
    hyperref,
    showlabels,

    changepage,

  }
\clist_new:N \g__wisper_all_features_main_clist

\NewDocumentCommand \Preamble { m }
  {
    \__wisper_enable_features:n {#1}

    \__wisper_load_document_class:

    % Early Package loads
    \__wisper_load_features:n { early_packages }
    \__wisper_load_features:n { font }
    % Adjust layout.
    \__wisper_if_document_class:nT {koma}
      { \KOMAoptions{DIV=last} }

    %% requires amsmath
    %\IfDocClassTF{book, scrbook}
    %  {\numberwithin{equation}{chapter}}
    %  {\numberwithin{equation}{section}}

    %\IfDocClassTF {beamer}
    %  { \__wisper_select_package_preset:nn {biblatex} {presentation} }
    %  { \__wisper_select_package_preset:nn {biblatex} {book} }
    %\__wisper_select_package_preset:nn {hyperref} {pale-colors}
    % here: enable features
    \__wisper_load_features:n { main_packages }
    \__wisper_load_features:n { main }
  }

\ExplSyntaxOff

% vim: ts=2 sw=2 et fdm=marker fmr=[[[,]]]:
