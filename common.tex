% This file should only contain things that can go into any kind of document.

% TODO: keyvals: draft (obvious), debug (load blind text packages), strict (whether to fail or fallback, e.g. for luatex-only features like specific fonts)
% TODO: math: automatically replace i/j i/jmath (have an option to prevent that)
% TODO: support passing style options to most of the commands, 
%       e.g. \vc[vecdisplay=bm]{x}


% Early packages loads required for handling the configuration [[[1
\RequirePackage{xparse}  % includes the l3 kernel

\ExplSyntaxOn

% Variants [[[1
\cs_generate_variant:Nn \clist_use:Nn {nn}

% Debugging helpers [[[1
\prg_new_conditional:Nnn \__wisper_if_debug:
  { p, T, F, TF}
  { 
    % TODO: configurable
    \prg_return_true:
  }

% Common messages [[[1
\msg_new:nnn { wisper } { unknown-choice }
  { Unknown~#1~'#2'.~Valid~choices~are~\clist_use:nn{#3}{,~}. }

% Common helper functions for package and document class loading [[[1
% Helper function to get the square brackets for passing optional arguments.
\cs_new:Npn \__wisper_load_with_optional_arg_aux:Nnn #1#2#3
  {
    #1[#2]{#3}
  }

% Helper function to transform the class option property list into a clist.
\cs_new:Npn \__wisper_build_clist_from_prop:NN #1#2
  {
    \__wisper_if_debug:T 
      { \prop_show:N #1 }

    \prop_map_inline:Nn #1
      {
        \clist_put_right:Nx #2
          {
            \str_if_eq:nnTF {##2} {}
              {##1,}
              {##1=##2,}
          }
      }
  }

\cs_new:Npn \__wisper_load_with_optional_arg:NNn #1#2#3
  {
    \clist_clear:N \l__tmpa_clist
    \__wisper_build_clist_from_prop:NN #2 \l__tmpa_clist
    \__wisper_if_debug:T
      {
        \clist_show:N \l__tmpa_clist
        \str_show:n {#3}
      }
    \exp_args:Noo \__wisper_load_with_optional_arg_aux:Nnn #1
      {
        \clist_use:Nn \l__tmpa_clist { ,~ }
      }
      { #3 }
  }
\cs_generate_variant:Nn \__wisper_load_with_optional_arg:NNn { NNV, Ncn}

% Convenience funtions for the key-value interface [[[1
\cs_new:Npn \__wisper_keys_define:n #1 { \keys_define:nn { wisper } {#1} }

\cs_new:Npn \__wisper_keys_define_internal:n #1 { \keys_define:nn { wisper/internal } {#1} }
\cs_new:Npn \__wisper_keys_define_doc:n #1 { \keys_define:nn { wisper/document } {#1} }
\cs_new:Npn \__wisper_keys_define_doc:nn #1#2 { \keys_define:nn { wisper/document/#1 } {#2} }
\cs_new:Npn \__wisper_keys_define_math:n #1 { \keys_define:nn { wisper/mathematics } {#1} }
\cs_new:Npn \__wisper_keys_define_code:n #1 { \keys_define:nn { wisper/code } {#1} }
\cs_new:Npn \__wisper_keys_define_phys:n #1 { \keys_define:nn { wisper/physics } {#1} }

\cs_new:Npn \__wisper_keys_set_internal:n #1 { \keys_set:nn { wisper/internal } {#1} }
\cs_new:Npn \__wisper_keys_set_doc:n #1 { \keys_set:nn { wisper/document } {#1} }
\cs_new:Npn \__wisper_keys_set_doc:nn #1#2 { \keys_set:nn { wisper/document/#1 } {#2} }
\cs_new:Npn \__wisper_keys_set_math:n #1 { \keys_set:nn { wisper/mathematics } {#1} }
\cs_new:Npn \__wisper_keys_set_code:n #1 { \keys_set:nn { wisper/code } {#1} }
\cs_new:Npn \__wisper_keys_set_phys:n #1 { \keys_set:nn { wisper/physics } {#1} }

% User-accessible aliases.
\NewDocumentCommand \DocumentStyle {m} { \keys_set:nn { wisper/document } {#1} }
%\NewDocumentCommand \MathStyle {m} { \keys_set:nn { wisper/math } {#1} }
%\NewDocumentCommand \CodeStyle {m} { \keys_set:nn { wisper/code } {#1} }
%\NewDocumentCommand \PhysStyle {m} { \keys_set:nn { wisper/phys } {#1} }

% Document class handling [[[1

% Global storage for class name and options.
\str_new:N \g__wisper_classname_str
\prop_new:N \g__wisper_classopts_prop

% Document class loader.
\cs_new:Nn \__wisper_load_document_class:
  {
    \__wisper_load_with_optional_arg:NNV
      \documentclass
      \g__wisper_classopts_prop
      \g__wisper_classname_str
  }

% Conditional for the document class.
\prg_new_conditional:Npnn \__wisper_if_document_class:n #1
  { p, T, F, TF}
  { 
    \str_if_eq:nnTF {#1} {koma}
      {
        % koma is an alias for any KOMA-script class
        \__wisper_if_document_class:nTF { scrartcl, scrbook, scrreprt, scrlttr2 }
          { \prg_return_true: }
          { \prg_return_false: }
      }
      {
        \clist_if_in:nVTF {#1} \g__wisper_classname_str 
          { \prg_return_true: }
          { \prg_return_false: }
      }
  }

\msg_new:nnn { wisper } { declaring-package } { Declaring~package~'#1'. }

% Package declaration helpers [[[1
\cs_new:Npn \__wisper_declare_package:n #1
  {
    \__wisper_if_debug:T
      { \msg_warning:nnn { wisper } { declaring-package } {#1} }

    \prop_new:c {g__wisper_package_ #1 _options_prop}
    \__wisper_keys_define_doc:n
      {
        packages/#1/enable .bool_gset:c = {g__wisper_package_ #1 _enabled_bool},
        packages/#1/enable .initial:n = {false},

        packages/#1/options / unknown .code:n =
          {
            \prop_gput:NVc {g__wisper_package_ #1 _options_prop}
                \l_keys_key_tl
                {#1}
          },

        packages/#1/conflicts / classes .tl_gset:c = {g__wisper_package_ #1 _conflicting_classes_tl},
        packages/#1/conflicts / packages .tl_gset:c = {g__wisper_package_ #1 _conflicting_packages_tl},
        packages/#1/conflicts / classes .initial:n = {},
        packages/#1/conflicts / packages .initial:n = {},

        % e.g. document classes can prevent loading a package, should raise an
        % error if enabled explicitly in some place.
        packages/#1/deactivate .bool_gset:c = {g__wisper_package_ #1 _deactivated_bool},
      }
  }

\cs_new:Npn \__wisper_declare_package:nn #1#2
  {
    \__wisper_declare_package:n {#1}
    \__wisper_set_package_configuration:nn {#1} {#2}
  }

\cs_new:Npn \__wisper_enable_package:n #1
  { \__wisper_keys_set_doc:n { packages/#1/enable = true } }

\cs_new:Npn \__wisper_disable_package:n #1
  { \__wisper_keys_set_doc:n { packages/#1/enable = true } }

\cs_new:Npn \__wisper_enable_package:nn #1#2
  {
    \clist_if_in:nnT {true, enable, enabled} {#2}
      { \__wisper_keys_set_doc:n { packages/#1/enable = true } }
    \clist_if_in:nnT {false, disable, disabled} {#2}
      { \__wisper_keys_set_doc:n { packages/#1/enable = false } }
  }

\cs_new:Npn \__wisper_declare_package_set_state:nn #1#2
  {
    \__wisper_declare_package:n {#1}
    \__wisper_enable_package:nn {#1} {#2}
  }

\cs_new:Npn \__wisper_set_package_configuration:nn #1#2
  { \__wisper_keys_set_doc:nn { packages/#1 } {#2} }

\cs_new:Npn \__wisper_set_package_options:nn #1#2
  { \__wisper_keys_set_doc:nn { packages/#1/options } {#2} }

\cs_new:Npn \__wisper_load_package:n #1
  {
    % TODO: respect forced deactivation
    \__wisper_load_with_optional_arg:Ncn
      \usepackage
      {g__wisper_package_ #1 _options_prop}
      {#1}
  }

% name=enabled clist
\cs_new:Npn \__wisper_declare_packages:n #1
  {
    \keyval_parse:NNn
      \__wisper_declare_package:n
      \__wisper_declare_package_set_state:nn
      {#1}
  }

% Package declarations [[[1
% TODO: package option presets!

% Bibliography [[[2
\__wisper_declare_packages:n
  {
    biblatex,
  }

% Generic [[[2
\__wisper_declare_packages:n
  {
    enumitem,
    calc = enabled,
    ragged2e = enabled,
    xcolor = enabled,
    url,
    hyperref,
    sidenotes,
    babel,
    fontenc,
    csquotes = enabled,
    microtype = enabled,
    inputenc,
    fancyhdr,
    amsthm,
    bigfoot,
  }

% Fonts, handled differently (for now?) [[[2
\__wisper_declare_packages:n
  {
    newpxmath,
    fontspec,
    newpxtext,
    lmodern,
    FiraSans,
    FiraMono,
    mathdesign,
    mathpazo,
  }

% Code display [[[2
\__wisper_declare_packages:n
  {
    minted = enabled,
  }

% Tables, figures [[[2
\__wisper_declare_packages:n
  {
    float = enabled,
    rotating = enabled,
    booktabs = enabled,
    array = enabled,
    multirow,
    tabu,
    caption = enabled,
    subcaption = enabled,
    graphicx = enabled,
  }

% TODO: require values for paper, languages, landscape, type. Or somehow
% support default values?
% -> Ensure that all keys can be set multiple times without issues.

% Document types [[[1
% Key-value interface to pre-defined document layouts ('document types'). [[[2
\__wisper_keys_define_doc:n
  {
    paper .choices:nn =
      { a4paper, a5paper }
      {
        \prop_put:NnV \g__wisper_classopts_prop \l_keys_choice_tl
      },
    paper / unknown .code:n =
      {
        \msg_error:nnnn { wisper } { unknown-choice }
          { paper~format }
          {#1}
          { a4paper, a5paper} % TODO: Don't hardcode
      },
    languages .initial:n = {english},
    %landscape .bool:,

    type .choice:,
    type / article .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {article}
        \str_set:Nn \g__wisper_classname_str {article}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
      },
    type / presentation .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {presentation}
        \str_set:Nn \g__wisper_classname_str {beamer}
      },
    type / letter .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {letter}
        \str_set:Nn \g__wisper_classname_str {scrlttr2}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
      },
    type / book .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {book}
        \str_set:Nn \g__wisper_classname_str {book}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
      },
    type / scrbook .code:n = 
      {
        \str_set:Nn \g__wisper_document_type_str {scrbook}
        \str_set:Nn \g__wisper_classname_str {scrbook}
        \prop_put:Nnn \g__wisper_classopts_prop {a4paper} {}
        \prop_put:Nnn \g__wisper_classopts_prop {BCOR} {0mm}
        \prop_put:Nnn \g__wisper_classopts_prop {DIV} {10}
        \prop_put:Nnn \g__wisper_classopts_prop {pagesize} {}
      },
    type / unknown .code:n =
      {
        \msg_error:nnnn { wisper } { unknown-choice }
          { document~type }
          {#1}
          { article, presentation, letter, book, scrbook } % TODO: Don't hardcode
      },
  }

% Conditionals [[[2
\prg_new_conditional:Npnn \__wisper_if_document_type:n #1
  { p, T, F, TF}
  { 
    \clist_if_in:nVTF {#1} \g__wisper_document_type_str
      { \prg_return_true: }
      { \prg_return_false: }
  }

% User-accessible aliases.
\cs_new_eq:NN \IfDocTypeT \__wisper_if_document_type:nT
\cs_new_eq:NN \IfDocTypeF \__wisper_if_document_type:nF
\cs_new_eq:NN \IfDocTypeTF \__wisper_if_document_type:nTF

\cs_new_eq:NN \IfDocClassT \__wisper_if_document_class:nT
\cs_new_eq:NN \IfDocClassF \__wisper_if_document_class:nF
\cs_new_eq:NN \IfDocClassTF \__wisper_if_document_class:nTF

% Font handling [[[1

% Property list to hold the loading code [[[2
\prop_new:N \__wisper_font_presets_prop
\prop_put:Nnn \__wisper_font_presets_prop { lmodern } % [[[3
  {
    \usepackage{lmodern}
  }
\prop_put:Nnn \__wisper_font_presets_prop { fira } % [[[3
  {
    % Mozilla Fira Sans, requires XeLaTeX or LuaLaTex TODO: raise error
    \usepackage[sfdefault]{FiraSans}
    \usepackage{FiraMono}
  }
\prop_put:Nnn \__wisper_font_presets_prop { garamond } % [[[3
  {
    % URW-Garamond: A free garamond font, supposedly good for books but to fragile
    %   for presentations. Math fonts provided by the mathdesign project
    \usepackage[urw-garamond]{mathdesign}
    % FIXME: maybe drop this? PagellaX is better anyway. At least give a
    % warning.
    % TODO: matching sans font
  }
\prop_put:Nnn \__wisper_font_presets_prop { palatino } % [[[3
  {
    \usepackage[osf]{mathpazo}
  }
\prop_put:Nnn \__wisper_font_presets_prop { TexGyre } % [[[3
  {
    \usepackage{amsthm}  % preload amsthm to suppress error due to newpxmath redfining \openbox
    \usepackage[vvarbb]{newpxmath}
    % TODO: tex/xetextex/luatex switch that is more readable
    \sys_if_engine_luatex:TF
      {
        % LuaTeX
        \usepackage[no-math]{fontspec}
        % TODO: ensure correct small caps, \usepackage[largesc]{newpxtext}
        \setmainfont{TeXGyrePagellaX}[Numbers=OldStyle]
        \setsansfont{TeXGyreHeros}
        % TODO: where appropriate, check for \liningnumtext to be defined and
        % use it.
        \newfontfamily\liningnumtext{TeXGyrePagellaX}[Numbers=Lining]
      }
      {
        \sys_if_engine_xetex:TF
          {
            % XeTeX
            \PackageError{---}{No~XeTeX~support~here.}
          }
          {
            % Other TeX
            \usepackage[largesc]{newpxtext}
            \useosf
          }
      }
    \linespread{1.05} 
  }

% Interface for font preset selection [[[2
\tl_new:N \g__wisper_font_preset_code_tl
\cs_new:Nn \__wisper_load_font:
  {
    \tl_use:N \g__wisper_font_preset_code_tl
  }
\__wisper_keys_define_doc:n
  {
    font/preset .code:n =
      {
        \prop_get:NnNF \__wisper_font_presets_prop {#1} \g__wisper_font_preset_code_tl
          {
            \msg_error:nnn { wisper } { unknown-choice }
              { font~preset }
              {#1}
              { lmodern, fira, garamond, palatino, TexGyre }
          }
      },

    % default
    font/preset .initial:n = {TexGyre},
  }

% Footnotes [[[1

\bool_new:N \g__wisper_footnotes_multiple_bool
\__wisper_keys_define_doc:n
  {
    footnotes/multiple .bool_gset:N = \g__wisper_footnotes_multiple_bool,
  }

% Citations [[[1
\__wisper_keys_define_doc:n
  {
    cite/style .choice:,
    cite/style/super .meta:n = {},
    cite/style/bracket .meta:n = {},

    cite/enable~footnote .meta:n =
      {
        footnotes/multiple = true,
      },
  }

% Tufte-style [[[1
\__wisper_keys_define_doc:n
  {
    tufte .meta:n =
      {
        cite/style = super,
        cite/enable~footnote,
      },

    internal/load~sidenotes .code:n = {},
    sidenotes/enable .meta:n =
      {
        internal/load~sidenotes .code:n =
          {
            \__wisper_if_document_type:nT {book, scrbook}
              { \usepackage{sidenotes} }
          }
      },
  }

% Load all the things [[[1
% Document class [[[2
\DocumentStyle{type=scrbook}
\__wisper_load_document_class:

% Early Package loads [[[2
\usepackage[main=english]{babel}
\usepackage[T1]{fontenc}
\__wisper_load_font:
% Adjust layout.
\__wisper_if_document_class:nT {koma}
  { \KOMAoptions{DIV=last} }


% Load packages [[[2
\DocumentStyle{internal/load sidenotes}

\newif\ifloadcode\loadcodetrue
\newif\ifloadmath\loadmathtrue
\newif\ifloadphys\loadphystrue

% Suppress inputenc warning for utf8 engines
\bool_if:nF { \sys_if_engine_xetex_p: || \sys_if_engine_luatex_p: }
  { \usepackage[utf8]{inputenc} }
\usepackage[T1]{fontenc}


% load minted before csquotes to suppress a warning due to a common package
% they load
\ifloadcode
  \__wisper_enable_package:n {minted}
\fi
\__wisper_load_package:n {minted}

\__wisper_load_package:n {csquotes}  % context-sensitive quotes

\__wisper_load_package:n {microtype}


% Misc [[[2
\IfDocClassF {beamer}
  { \usepackage[inline]{enumitem} }  % doesn't play well with overlay specifications
\__wisper_load_package:n {float}  %
%\usepackage{xparse}
\__wisper_load_package:n {calc}
%\usepackage{fancyhdr}  %
\__wisper_load_package:n {ragged2e}


% Colors [[[2
\__wisper_load_package:n {xcolor}


% Hyperlinks [[[2
\IfDocClassF {beamer}
  { \usepackage[hyphens]{url} }  % loaded early by hyperref which is loaded way to early by beamer...
%\usepackage{hyperref}


% Better tables [[[2
\__wisper_load_package:n {rotating}
\__wisper_load_package:n {booktabs}
\__wisper_load_package:n {array}
%\__wisper_load_package:n {multirow}
%\__wisper_load_package:n {tabu}


% Graphics [[[2
\__wisper_load_package:n {graphicx}  % advanced key=value arguments for \includegraphics
\__wisper_load_package:n {caption}
\__wisper_load_package:n {subcaption}


% Bibliography [[[2
% many of these options can only be given in \usepackage and not later, unfortunately..
\IfDocClassTF {beamer}
    {\usepackage[hyperref=true,
                 backref=true,
                 style=alphabetic,
                 citereset=section,
                 url=false,
                 isbn=false,%  DOI only
                 maxcitenames=3,
                 maxbibnames=3]{biblatex}}
    {\usepackage[hyperref=true,
                 backref=true,
                 %bibstyle=authoryear,
                 bibstyle=numeric,
                 %bibstyle=alphabetic,
                 citestyle=custom-numeric-comp,
                 %citestyle=numeric-comp,
                 %citestyle=custom-alphabetic,
                 citereset=section,
                 url=false,
                 isbn=false,%  DOI only
                 maxcitenames=3,
                 maxbibnames=3]{biblatex}}


% New packages to investigate [[[2
%\usepackage{subfigure}
%\usepackage{geometry}
%\usepackage{pdfpages}
%\usepackage{cite}  % better support for numeric citations
%\usepackage{longtable}  % wrap tables at page boundaries, succeeds supertabular
%\usepackage{supertabular}  % wrap tables at page boundaries
%\usepackage{wrapfig}
%\usepackage{footmisc}
%\usepackage{epstopdf}
%\usepackage{textcomp}
%\usepackage{marginnote}

% Packages that need to be loaded last [[[2
\__wisper_load_package:n {hyperref}
%\usepackage[inner]{showlabels}

% Configure packages, define commands [[[1

%\mhchemoptions{textfontcommand=\liningnumtext}
%\IfPresentationT{\renewcommand*{\bibfont}{\scriptsize}}

% Generic layout-related packages [[[2
% TODO: if twoside, maybe only if sidenotes/book?
\usepackage[strict]{changepage}

% Footnotes [[[2
\__wisper_load_package:n {bigfoot}
\DeclareNewFootnote{default}[alph]

% Citations [[[2
\let\footnote\footnotedefault
\let\footnotemark\footnotemarkdefault
\let\footnotetext\footnotetextdefault
\DeclareNewFootnote{Cite}

% Layout for KOMA [[[2
\IfDocTypeT{koma}
  {
    % Fix chapter/section titles defaulting to sans (i.e. CM) fonts
    \setkomafont{disposition}{\normalfont\bfseries}
    \KOMAoptions{headings=normal}
    % Fix fonts in the toc
    \setkomafont{chapterentry}{\normalfont\bfseries}
    % fix item font in descriptions and enumerates
    \setkomafont{descriptionlabel}{\normalfont\bfseries}
    \setkomafont{labelinglabel}{\normalfont\bfseries}
    % Suppress warnings on font fallback
    \renewcommand\labelitemi{{\fontfamily{cmr}\selectfont\textbullet}}
    \renewcommand\labelitemiii{{\fontfamily{cmr}\selectfont\textasteriskcentered}}
    \renewcommand\labelitemiv{{\fontfamily{cmr}\selectfont\textperiodcentered}}
    %
    % Titlepage
    \KOMAoptions{titlepage=firstiscover}
    %
    % Footnotes
    \KOMAoptions{footnotes=multiple}
    \renewcommand{\multfootsep}{,}
    %
    % Header/Footer
    \usepackage[draft=false]{scrlayer-scrpage}
    \pagestyle{scrheadings}
    \automark[chapter]{chapter}
    \automark*[section]{}
    \ihead{}
    \chead{\headmark}
    \ohead{\pagemark}
    \ifoot{}
    \cfoot{}
    \ofoot{}
    %\KOMAoptions{headsepline=true}
    %\KOMAoptions{footsepline=:0.5\textwidth, olines}
  }

% Colors [[[2
\__wisper_load_package:n {xcolor}
% define a few highlighting colors, from https://personal.sron.nl/~pault/
\definecolor{marklightblue}{HTML}{BBCCEE}
\definecolor{marklightteal}{HTML}{CCEEFF}
\definecolor{marklightgreen}{HTML}{CCDDAA}
\definecolor{marklightsand}{HTML}{EEEEBB}
\definecolor{marklightred}{HTML}{FFCCCC}
\definecolor{markdarkblue}{HTML}{222255}
\definecolor{markdarkteal}{HTML}{225555}
\definecolor{markdarkgreen}{HTML}{225522}
\definecolor{markdarksand}{HTML}{666633}
\definecolor{markdarkred}{HTML}{663333}


% Tables [[[2
% https://tex.stackexchange.com/a/2442/111880
% https://tex.stackexchange.com/a/12712/111880
\newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
\newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}

% Figures, tables, ... [[[2
\DeclareCaptionStyle{myfigure}{font=footnotesize,%
                               labelfont=sc,%
                               }
\captionsetup{style=myfigure}  % default

% TODO: as for changepage: better conditional, cf. above
\__wisper_if_document_type:nT {book, scrbook}
  {
    \DeclareCaptionJustification{raggedoutside}{\raggedoutside}
    \newcommand\raggedoutside
      {%
        \checkoddpage%
        \ifoddpage%
          \RaggedRight%
        \else%
          \RaggedLeft%
        \fi%
      }

  \NewDocumentEnvironment{flushinside}{}
    {%
      \checkoddpage%
      \bgroup%
      \ifoddpage%
        \flushleft%
      \else%
        \flushright%
      \fi%
    }
    {%
      \egroup%
    }

  \DeclareCaptionStyle{marginfigure}{justification=raggedoutside,%
                                     font=footnotesize,%
                                     labelfont=sc,%
                                     }

  \DeclareCaptionStyle{margintable}{justification=raggedoutside,%
                                    font=footnotesize,%
                                    labelfont=sc,%
                                    }

  \DeclareCaptionStyle{sidecaption}{justification=raggedoutside,%
                                    font=footnotesize,%
                                    labelfont=sc,%
                                    }
  \newlength{\realmarginparwidth}
  \setlength{\realmarginparwidth}{\marginparwidth}
  \addtolength{\realmarginparwidth}{\marginparsep}

  \DeclareCaptionStyle{widetable}{%justification=raggedoutside,%
                                  font=footnotesize,%
                                  labelfont=sc,%
                                  margin={0pt, \realmarginparwidth}
                                  }
  }

% Hyperlinks [[[2
\hypersetup{%
    colorlinks=true,
    linkcolor=black,  % for internal links, color is just too much
    citecolor=markdarkteal,
    filecolor=markdarkgreen,
    urlcolor=markdarkblue,
    bookmarksopen=true,
    bookmarksopenlevel=3
}


% Bibliography [[[2
% From http://www.khirevich.com/latex/footnote_citation/
% new command \sjcitep prints footnote citation above punctuation
\newlength{\spc} % declare a variable to save spacing value
% TODO: ensure that this works when there are non-cite footnotes on the same page
\NewDocumentCommand{\citep}{D<>{} o o m}{% new command with two arguments: optional (#1) and mandatory (#2)
        \settowidth{\spc}{#1}% set value of \spc variable to the width of #1 argument
        \addtolength{\spc}{-1.8\spc}% subtract from \spc about two (1.8) of its values making its magnitude negative
        #1% print the optional argument
        \hspace*{\spc}% print an additional negative spacing stored in \spc after #1
        \IfNoValueTF{#2}
            {\supershortnotecite{#4}}
            {\IfNoValueTF{#3}
                {\supershortnotecite[#2]{#4}}
                {\supershortnotecite[#2][#3]{#4}}}
    }% print (cite) the mandatory argument


% New Commands [[[2
% unnumbered section that shows up in the TOC
\newcommand{\tocsection}[1]{\section*{#1}\addcontentsline{toc}{section}{#1}}
% non-numbered subsection that works properly with hyperref
\newcommand{\nonumchapter}[1]{\phantomsection\addcontentsline{toc}{chapter}{#1}}
\newcommand{\nonumsection}[1]{\phantomsection\addcontentsline{toc}{section}{#1}}
\newcommand{\nonumsubsection}[1]{\phantomsection\addcontentsline{toc}{subsection}{#1}}
\newcommand{\nonumsubsubsection}[1]{\phantomsection\addcontentsline{toc}{subsubsection}{#1}}

% Draft mode [[[2
%\renewcommand{\showlabelfont}{\tiny\ttfamily}
%\showlabels{cite}
%\showlabels{ref}
%\showlabels{begin}

\newcounter{todonotecounter}
\NewDocumentCommand \margintodo {s o m} 
  {
    \stepcounter{todonotecounter}
    \IfBooleanTF{#1}{}{%
      \marginpar{%
        \IfValueT{#2}{\vspace{#2}}%
        \raggedoutside
        \footnotesize%
        \fcolorbox{red}{white}{\color{red} \thetodonotecounter}%
        #3%
      }
    }
  }


% Math [[[2
\IfDocClassTF{book, scrbook}
  {\numberwithin{equation}{chapter}}
  {\numberwithin{equation}{section}}

%\MathStyle
%  {
%    integrate/displayfunc=outset,
%    vecdisplay=bold,
%  }

% TODO: remember to set locale correctly!!
%\sisetup{%
%  separate-uncertainty=true,
%  %locale = DE,
%  %per-mode = symbol
%}

\ExplSyntaxOff

% vim: ts=2 sw=2 et fdm=marker fmr=[[[,]]]:
