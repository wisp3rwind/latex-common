% This file should only contain things that can go into any kind of document.

% TODO: keyvals: draft (obvious), debug (load blind text packages), strict (whether to fail or fallback, e.g. for luatex-only features like specific fonts)
% TODO: math: automatically replace i/j i/jmath (have an option to prevent that)
% TODO: support passing style options to most of the commands, 
%       e.g. \vc[vecdisplay=bm]{x}
% TODO: 'features' that bundle packages + additional commands/configuration
% -> fonts are nothing but features!
% TODO: append code to package setup (independent of enabling)
% TODO: engine-specific features, engine={luatex,xetex}
% TODO: for unknown features, just assume that they are a package and automically define
% them instead of failing with an unintlligible error

% New packages to investigate
% subfigure
% geometry
% pdfpages
% cite  % better support for numeric citations
% longtable  % wrap tables at page boundaries, succeeds supertabular
% supertabular  % wrap tables at page boundaries
% wrapfig
% footmisc
% epstopdf
% textcomp
% marginnote


%\mhchemoptions{textfontcommand=\liningnumtext}
%\IfPresentationT{\renewcommand*{\bibfont}{\scriptsize}}

% TODO: remember to set locale correctly!!
%\sisetup{%
%  separate-uncertainty=true,
%  %locale = DE,
%  %per-mode = symbol
%}


% Early packages loads required for handling the configuration [[[1
\RequirePackage{xparse}  % includes the l3 kernel

\ExplSyntaxOn



% Variants [[[1
%\cs_new_eq:NN \__wisper_pass_options_to_package:nn \PassOptionsToPackage
\cs_generate_variant:Nn \bool_not_p:n { v }
\cs_generate_variant:Nn \bool_if_p:n { v }
\cs_generate_variant:Nn \bool_if:nT { xT }
\cs_generate_variant:Nn \keyval_parse:NNn { NNv, NNo }
\cs_generate_variant:Nn \msg_error:nnnn { nnnx }
\exp_args_generate:n { nxx } % -> \exp_args:Nnxx
\cs_generate_variant:Nn \regex_replace_all:nnN { nnc }
% Package: xtemplate
\cs_new:Npn \__wisper_xtemplate_DeclareInstance:nnnn { \DeclareInstance }
\cs_new:Npn \__wisper_xtemplate_UseInstance:nnnw { \UseInstance }  % -> w-type argument because this reads a variable number of arguments depending on the template
\cs_generate_variant:Nn \__wisper_xtemplate_DeclareInstance:nnnn { nxnn }
\cs_generate_variant:Nn \__wisper_xtemplate_UseInstance:nnnw { nxxw }
% Package: mdframed
\cs_new:Npn \__wisper_mdfdefinestyle:nn { \mdfdefinestyle }
\cs_generate_variant:Nn \__wisper_mdfdefinestyle:nn { nx }


% Additions to l3kernel [[[1
% \__wisper_strlist_if_in:nn, code is very similar to \__prop_if_in [[[2
% in contrast to \clist_if_in:nn, this is expandable
\prg_new_conditional:Npnn \__wisper_strlist_if_in:nn #1#2 { p, T, F, TF }
  {
    \__wisper_strlist_if_in:nww { #2 } #1 , #2 , \q_recursion_tail
    \__prg_break_point:
  }
\cs_new:Npn \__wisper_strlist_if_in:nww #1 #2 ,
  {
    \str_if_eq:nnTF {#1} {#2}
      { \__wisper_strlist_if_in:N }
      { \__wisper_strlist_if_in:nww {#1} }
  }
\cs_new:Npn \__wisper_strlist_if_in:N #1
  {
    \if_meaning:w \q_recursion_tail #1
      \prg_return_false:
    \else:
      \prg_return_true:
    \fi:
    \__prg_break:
  }
\cs_generate_variant:Nn \__wisper_strlist_if_in:nnTF { nVTF }
\cs_generate_variant:Nn \__wisper_strlist_if_in_p:nn { nV }

% \__wisper_if_engine:n, allows checking if on any of the given engines [[[2
\prg_new_conditional:Npnn \__wisper_if_engine:n #1 { p, T, F, TF }
  {
    \__wisper_strlist_if_in:nVTF {#1} \c_sys_engine_str
    %\clist_if_in:nVTF {#1} \c_sys_engine_str
      { \prg_return_true: }
      { \prg_return_false: }
  }
\cs_generate_variant:Nn \__wisper_if_engine:nTF { vTF }
\cs_generate_variant:Nn \__wisper_if_engine_p:n { v }

% \__wisper_switch_engine:n switch statement, code mostly borrowed from \__str_case:nnTF [[[2
\cs_new:Npn \__wisper_switch_engine:n #1
  {
    \exp:w
    \__wisper_switch_engine_aux:nTF {#1} { } { }
  }
\cs_new:Npn \__wisper_switch_engine:nT #1#2
  {
    \exp:w
    \__wisper_switch_engine_aux:nTF {#1} {#2} { }
  }
\cs_new:Npn \__wisper_switch_engine:nF #1
  {
    \exp:w
    \__wisper_switch_engine_aux:nTF {#1} { }
  }
\cs_new:Npn \__wisper_switch_engine:nTF #1
  {
    \exp:w
    \__wisper_switch_engine_aux:nTF {#1}
  }

\cs_new:Npn \__wisper_switch_engine_aux:nTF #1#2#3
  { \__wisper_switch_engine_aux:VnTF \c_sys_engine_str {#1} {#2} {#3} }
\cs_new:Npn \__wisper_switch_engine_aux:nnTF #1#2#3#4
  { \__wisper_switch_engine:nw {#1} #2 {#1} { } \q_mark {#3} \q_mark {#4} \q_stop }
\cs_generate_variant:Nn \__wisper_switch_engine_aux:nnTF { VnTF }
\cs_new:Npn \__wisper_case_end:nw #1#2#3 \q_mark #4#5 \q_stop
  { \exp_end: #1 #4 }
\cs_new:Npn \__wisper_switch_engine:nw #1#2#3
  {
    \__wisper_strlist_if_in:nnTF {#2} {#1}
      { \__wisper_case_end:nw {#3} }
      { \__wisper_switch_engine:nw {#1} }
  }
% Old, unused code [[[2
\cs_new:Npn \__wisper_prop_keys_to_clist:NN #1#2
  {
    \clist_clear:N #2
    \prop_map_inline:Nn #1 { \clist_put_right:Nn #2 {##1} }
  }
\cs_generate_variant:Nn \__wisper_prop_keys_to_clist:NN { cN }



% Debugging helpers [[[1
\clist_new:N \g__wisper_debug_modules_clist
\clist_gset:Nn \g__wisper_debug_modules_clist {}
\clist_gset:Nn \g__wisper_debug_modules_clist { loader, declaration, shipout, features }
\clist_gset:Nn \g__wisper_debug_modules_clist { features }
\prg_new_conditional:Nnn \__wisper_if_debug:n { T, F, TF }
  { 
    \clist_if_in:NnTF \g__wisper_debug_modules_clist {#1}
      { \prg_return_true: }
      { \prg_return_false: }
  }



% Common messages [[[1
\msg_new:nnn { wisper } { unknown-choice }
  { Unknown~#1~'#2'.~Valid~choices~are~\clist_use:Nn #3 { ,~ }. }
\msg_new:nnn { wisper } { declaring-feature }
  { Declaring~feature~'#1'. }
\msg_new:nnn { wisper } { feature-multiply-declared }
  { Feature~'#1'~already~declared. }
\msg_new:nnn { wisper } { enabling-feature }
  { Enabling~feature~'#1'. }
\msg_new:nnn { wisper } { disabling-feature }
  { Disabling~feature~'#1'. }
\msg_new:nnn { wisper } { check-activating-feature }
  { Checking~whether~to~activate~feature~'#1'. }
\msg_new:nnn { wisper } { activating-feature }
  { Activating~feature~'#1'~and~dependencies~'#2'. }
\msg_new:nnn { wisper } { check-activating-dependency }
  { Checking~whether~to~activate~dependency~'#1'. }
\msg_new:nnn { wisper } { activating-dependency }
  { Activating~dependency~'#1'. }
\msg_new:nnn { wisper } { check-loading-feature }
  { Checking~whether~to~load~feature~'#1'. }
\msg_new:nnn { wisper } { loading-feature }
  { Loading~feature~'#1'. }
\msg_new:nnn { wisper } { no-such-feature-option }
  { No~such~option~('#2')~for~feature~'#1'. }



% Sequence and helper function to store the generated preamble [[[1
\seq_new:N \g__wisper_preamble_seq
\cs_new:Npn \__wisper_shipout:n #1
  {
    % Reading the code as an argument will have doubled hashes, undo this
    \tl_set:Nn \l_tmpa_tl { #1 }
    %\regex_replace_all:nnN { \cP\# } { \cO\# } \l_tmpa_tl
    \regex_replace_all:nnN { \c{ __wisper_parameter_token: } } { \cO\# } \l_tmpa_tl
    \seq_gput_right:NV \g__wisper_preamble_seq \l_tmpa_tl
    \__wisper_if_debug:nT { shipout }
      { \seq_show:N \g__wisper_preamble_seq }
  }
\cs_generate_variant:Nn \__wisper_shipout:n { x }



% Common helper functions for package and document class loading [[[1
% Helper function to get the square brackets for passing optional arguments.
\cs_new:Npn \__wisper_load_with_optional_arg_aux:Nnn #1#2#3
  {
    \__wisper_shipout:n { #1[#2]{#3} }
  }
\cs_generate_variant:Nn \__wisper_load_with_optional_arg_aux:Nnn { Nxo }

% Helper function to transform the class option property list into a clist.
\cs_new:Npn \__wisper_build_clist_from_prop:NN #1#2
  {
    \__wisper_if_debug:nT { loader }
      { \prop_show:N #1 }

    \prop_map_inline:Nn #1
      {
        \tl_if_novalue:nTF {##2}
          { \clist_put_right:Nn #2 {##1} }
          { \clist_put_right:Nn #2 {##1=##2} }
      }
  }

\cs_new:Npn \__wisper_load_with_optional_arg:NNn #1#2#3
  {
    \clist_clear:N \l_tmpa_clist
    \__wisper_build_clist_from_prop:NN #2 \l_tmpa_clist
    \__wisper_if_debug:nT { loader }
      {
        \clist_show:N \l_tmpa_clist
        \str_show:n {#3}
      }
    \__wisper_load_with_optional_arg_aux:Nxo #1
      {
        % Previously, this code introduced an additional space ( { ,~ } ). This
        % will apparently not be stripped when loading the document class with
        % the result that _all_ option will be ignored (and result in the 
        % warning "Unused global options [...]".
        \clist_use:Nn \l_tmpa_clist { , }
      }
      { #3 }
  }



% Convenience functions for the key-value interface [[[1
\cs_new:Npn \__wisper_keys_define:n #1 { \keys_define:nn { wisper } {#1} }

\cs_new:Npn \__wisper_keys_define_internal:n #1 { \keys_define:nn { wisper/internal } {#1} }
\cs_new:Npn \__wisper_keys_define_doc:n #1 { \keys_define:nn { wisper/document } {#1} }
\cs_new:Npn \__wisper_keys_define_doc:nn #1#2 { \keys_define:nn { wisper/document/#1 } {#2} }

\cs_new:Npn \__wisper_keys_set_internal:n #1 { \keys_set:nn { wisper/internal } {#1} }
\cs_new:Npn \__wisper_keys_set_doc:n #1 { \keys_set:nn { wisper/document } {#1} }
\cs_new:Npn \__wisper_keys_set_doc:nn #1#2 { \keys_set:nn { wisper/document/#1 } {#2} }



% Document class handling [[[1

% Global storage for class name and options.
\prop_new:N \g__wisper_classopts_prop

% Conditional for the document class.   [[[2
\cs_new:Npn \__wisper_if_document_class_aux:n #1
  {
    % No match
    \quark_if_nil:nTF { #1 }
      { \clist_map_break:n { \prg_return_false: } }
      {
        % Recurse for aliases
        \str_if_eq:nnTF { #1 } { koma }
          {
            % koma is an alias for any KOMA-script class
            \__wisper_if_document_class:nT { scrartcl, scrbook, scrreprt, scrlttr2 }
              { \clist_map_break:n { \prg_return_true: } }
          }
          {
            % Match
            \__wisper_if_feature_enabled:nT { class- #1 }
              { \clist_map_break:n { \prg_return_true: } }
          }
      }
  }
\prg_new_conditional:Npnn \__wisper_if_document_class:n #1 { p, T, F, TF }
  { 
    % For some reason, not wrapping \q_nil in braces doesn't properly store it
    % in the clist and breaks the whole mapping
    \clist_map_function:nN { #1 , {\q_nil} } \__wisper_if_document_class_aux:n
  }
\cs_generate_variant:Nn \__wisper_if_document_class:nTF { vTF }
\cs_generate_variant:Nn \__wisper_if_document_class_p:n { v }

% Key-value interface to pre-defined document layouts ('document types'). [[[2
% TODO: require values for paper, roman/sans, languages, landscape, tocdepth, type. Or somehow
% support default values?
% -> Ensure that all keys can be set multiple times without issues.
\clist_gset:Nn \g__wisper_valid_paper_formats_clist { a4paper, a5paper }
\__wisper_keys_define_doc:n
  {
    paper .choices:Vn =
      \g__wisper_valid_paper_formats_clist
      {
        \__wisper_store_classopt:nV \l_keys_choice_tl
      },
    paper / unknown .code:n =
      {
        \msg_error:nnnnn { wisper } { unknown-choice }
          { paper~format }
          {#1}
          \g__wisper_valid_paper_formats_clist
      },
    languages .code:n =
      {
        \clist_map_inline:nn {#1}
          { \__wisper_store_classopt:n {##1} }
      },
    main_language .code:n =
      {
        \PassOptionsToPackage {main=#1} {babel} 
        %\prop_put:Nnn \g__wisper_classopts_prop {#1} {}
      },

    %languages .initial:n = {english},

    %landscape .bool:,
  }
%\__wisper_declare_feature:nnn { language }
%  {
%    declare~options =
%      {
%        main = 
%      }
%  }
%  {
%  }

% Features [[[1
% Aliases to enable features to be coded without using expl3 [[[2
% TODO: only set them locally when expanding feature code
\cs_new_eq:NN \IfDocClassT \__wisper_if_document_class:nT
\cs_new_eq:NN \IfDocClassF \__wisper_if_document_class:nF
\cs_new_eq:NN \IfDocClassTF \__wisper_if_document_class:nTF

% Feature management [[[2
\prop_new:N \g__wisper_feature_features_prop
\prop_new:N \g__wisper_feature_code_prop
\tl_new:N \g__wisper_feature_code_tl
\seq_new:N \g__wisper_all_features_all_seq

\cs_new:Npn \__wisper_declare_feature_aux:nnn #1#2#3
  {
    % #1 - name
    % #2 - keyvals
    % #3 - code
    \__wisper_if_debug:nT { declaration }
      { \msg_warning:nnn { wisper } { declaring-feature } { #1 } }
    \cs_if_exist:cT { g__wisper_feature_ #1 _enabled_bool }
      { \msg_error:nnn { wisper } { feature-multiply-declared } { #1 } }
    \bool_gset_false:c { g__wisper_feature_ #1 _enabled_bool }
    \bool_gset_false:c { g__wisper_feature_ #1 _activated_bool }
    \bool_gset_false:c { g__wisper_feature_ #1 _loaded_bool }
    \clist_new:c { g__wisper_feature_ #1 _dependencies_clist }
    \clist_new:c { g__wisper_feature_ #1 _conditional_dependencies_clist }
    \tl_set:Nn \l_tmpa_tl { #3 }
    \regex_replace_all:nnN { \cP\# } { \c{ __wisper_parameter_token: } } \l_tmpa_tl
    \tl_gset_eq:cN { g__wisper_feature_ #1 _code_tl } \l_tmpa_tl
    \bool_gset_false:c { g__wisper_feature_ #1 _expl3_bool }
    \bool_gset_false:c { g__wisper_feature_ #1 _makeatletter_bool }
    \clist_new:c { g__wisper_feature_ #1 _conflicting_features_clist }
    \seq_put_right:Nn \g__wisper_all_features_all_seq { #1 }

    \__wisper_keys_define_doc:n
      {
        features/#1/enabled .code:n = { \__wisper_enable_feature:n {#1} },
        features/#1/enabled .value_forbidden:n = true,
        features/#1/disabled .code:n = { },
        features/#1/disabled .value_forbidden:n = true,

        features/#1/expl3 .bool_gset:c = { g__wisper_feature_ #1 _expl3_bool },
        features/#1/makeatletter .bool_gset:c = { g__wisper_feature_ #1 _makeatletter_bool },

        features/#1/groups .code:n =
          {
            \clist_map_inline:nn { ##1 }
              {
                \seq_if_exist:cF { g__wisper_all_features_ ####1 _seq }
                  { \seq_new:c { g__wisper_all_features_ ####1 _seq } }
                \seq_gput_right:cn { g__wisper_all_features_ ####1 _seq } { #1 }
              }
          },

        features/#1/requires .clist_gset:c = { g__wisper_feature_ #1 _dependencies_clist },
        features/#1/requires-conditional .clist_gset:c =
          { g__wisper_feature_ #1 _conditional_dependencies_clist },

        features/#1/options / unknown .code:n =
          { \msg_error:nnnx { wisper } { no-such-feature-option } { #1 } { \l_keys_key_tl=##1 } },
        features/#1/declare~options .code:n =
          {
            \__wisper_keys_define_doc:nn { features/#1/options } { ##1 }
          },
        features/#1/classoptions .clist_gset:c = { g__wisper_feature_ #1 _classopts_clist },

        features/#1/conflicts / classes .tl_gset:c = { g__wisper_feature_ #1 _conflicting_classes_tl },
        %features/#1/conflicts / features .clist_gset:c = {g__wisper_feature_ #1 _conflicting_features_clist},
        features/#1/conflicts / classes .initial:n = { },
        %features/#1/conflicts / features .initial:n = { },

        % e.g. document classes can prevent loading a feature, should raise an
        % error if enabled explicitly in some place.
        features/#1/deactivate .bool_gset:c = {g__wisper_feature_ #1 _deactivated_bool},
        features/#1/deactivate_for_engines .tl_gset:c =
          { g__wisper_feature_ #1 _deactivated_for_engines_strlist },
        features/#1/deactivate_for_engines .initial:n = { },
        features/#1/deactivate_for_classes .tl_gset:c =
          { g__wisper_feature_ #1 _deactivated_for_classes_strlist },
        features/#1/deactivate_for_classes .initial:n = { },
      }

      \__wisper_set_feature_config:nn { #1 } { #2 }
  }

\cs_new:Npn \__wisper_set_feature_config:nn #1#2
  { \__wisper_keys_set_doc:nn { features/#1 } { #2 } }
\cs_new:Npn \__wisper_set_feature_config:nnn #1#2#3
  { \__wisper_keys_set_doc:nn { features/#1/#2 } { #3 } }

\cs_new:Npn \__wisper_disable_feature:n #1
  {
    \__wisper_if_debug:nT { features }
      { \msg_warning:nnn { wisper } { disabling-feature } { #1 } }
    \bool_gset_false:c { g__wisper_feature_ #1 _enabled_bool }
  }
\cs_new:Npn \__wisper_enable_feature:n #1
  {
    \bool_if:cF { g__wisper_feature_ #1 _enabled_bool }
      {
        %\clist_show:c {g__wisper_feature_ #1 _conflicting_features_clist}
        \clist_map_inline:cn { g__wisper_feature_ #1 _conflicting_features_clist }
          {
            % TODO: error out if activated already
            \__wisper_disable_feature:n { ##1 }
          }
        \__wisper_if_debug:nT { features }
          { \msg_warning:nnn { wisper } { enabling-feature } { #1 } }
        \bool_gset_true:c { g__wisper_feature_ #1 _enabled_bool }
      }
  }
\prg_new_conditional:Npnn \__wisper_if_feature_enabled:n #1 { T, F, TF }
  {
    \bool_if:cTF { g__wisper_feature_ #1 _enabled_bool }
      { \prg_return_true: } { \prg_return_false: }
  }
\cs_new:Npn \__wisper_enable_feature_set_options:nn #1#2
  {
    \__wisper_enable_feature:n { #1 }
    \__wisper_set_feature_config:nn { #1 }  { options={#2} }
  }
\cs_new:Npn \__wisper_disable_features_group_except_group:nn #1#2
  {
    \__wisper_loop_features_groups:nn { #1 }
      {
        \seq_if_in:cnF { g__wisper_all_features_ #2 _seq } { ##1 }
          { \__wisper_disable_feature:n { ##1 } }
      }
    }
\cs_new:Npn \__wisper_activate_feature_dep_set_options:nn #1#2
  {
    \__wisper_if_debug:nT { features }
      { \msg_warning:nnx { wisper } { activating-dependency } { #1 } }
    %\msg_warning:nnn { wisper } { enabling-feature } { Dep:~#1 }
    \__wisper_enable_feature:n { #1 }
    \__wisper_set_feature_config:nn { #1 }  { options={#2} }
    % Recursively activate dependencies.
    \__wisper_activate_feature:n { #1 }
  }
\cs_new:Npn \__wisper_activate_feature_dep:n #1
  {
    \__wisper_if_debug:nT { features }
      { \msg_warning:nnx { wisper } { activating-dependency } { #1 } }
    %\msg_warning:nnn { wisper } { enabling-feature } { Dep:~#1 }
    \__wisper_enable_feature:n { #1 }
    % Recursively activate dependencies.
    \__wisper_activate_feature:n { #1 }
  }
\cs_new_protected:Npn \__wisper_activate_feature:n #1
  {
    \__wisper_if_debug:nT { features }
      { \msg_warning:nnn { wisper } { check-activating-feature } { #1 } }
    \__wisper_should_load_feature:nT { #1 }
      {
        \bool_if:cF { g__wisper_feature_ #1 _activated_bool }
          {
            \__wisper_if_debug:nT { features }
              {
                \msg_warning:nnxx { wisper } { activating-feature }
                  { #1 } { \clist_use:cn { g__wisper_feature_ #1 _dependencies_clist } { ,~ } }
              }
            % Activate unconditional dependencies
            \keyval_parse:NNv
              \__wisper_activate_feature_dep:n
              \__wisper_activate_feature_dep_set_options:nn
              { g__wisper_feature_ #1 _dependencies_clist }
            % FIXME: This only works for simple conditionals without complicated
            % recursive conditionals. To work as expected in any situation, it
            % would be necessary to loop through the conditional dependencies at
            % a higher level (probably in \__wisper_build_preamble:n) until
            % no changes (i.e. no additionally enabled features) occur anymore.
            % TODO: Document that the conditionals MUST be expandable.
            \clist_map_inline:cn { g__wisper_feature_ #1 _conditional_dependencies_clist }
              {
                \__wisper_if_debug:nT { features }
                  { \msg_warning:nnx { wisper } { check-activating-dependency } { \use_ii:nn ##1 } }
                \bool_if:xT { \use_i:nn ##1 }
                  {
                    \keyval_parse:NNo
                      \__wisper_activate_feature_dep:n
                      \__wisper_activate_feature_dep_set_options:nn
                        { \use_ii:nn ##1 }
                  }
              }
            \__wisper_store_classopts_from_clist:v { g__wisper_feature_ #1 _classopts_clist }
            \bool_gset_true:c { g__wisper_feature_ #1 _activated_bool }
          }
      }
  }
\cs_new:Npn \__wisper_enable_features:n #1
  {
    \clist_map_function:nN { #1 } \__wisper_enable_feature:n
  }
\cs_new:Npn \__wisper_activate_features:n #1
  {
    \clist_map_function:nN { #1 } \__wisper_activate_feature:n
  }
\cs_new:Npn \__wisper_loop_features_groups:nN #1#2
  {
    \clist_map_inline:nn { #1 }
      {
        \seq_map_inline:cn { g__wisper_all_features_ ##1 _seq }
          { #2 { ####1 } }
      }
  }
\cs_new:Npn \__wisper_loop_features_groups:nn #1#2
  {
    \cs_set:Npn \l_tmpa_cs:n ##1 { #2 }
    \__wisper_loop_features_groups:nN { #1 } \l_tmpa_cs:n
  }
\cs_new:Npn \__wisper_activate_features_group:n #1
  { \__wisper_loop_features_groups:nN { #1 } \__wisper_activate_feature:n }
\msg_new:nnn { wisper } { feature-executing } { Executing~feature-code~'#1'. }
\cs_new:Nn \__wisper_load_features: 
  {
    \prop_map_inline:Nn \g__wisper_feature_code_prop
      {
        \__wisper_if_debug:nT { features }
          { \msg_warning:nnn { wisper } { feature-executing } {##1} }
        \use:n { ##2 }
      }
  }

\cs_new:Npn \__wisper_declare_mutually_exclusive_features:n #1
  {
    % When enabling one such feature, disable all of the others
    \clist_map_inline:nn { #1 }
      {
        \clist_put_right:cn { g__wisper_feature_ ##1 _conflicting_features_clist }
          { #1 }
        \clist_gremove_duplicates:c { g__wisper_feature_ ##1 _conflicting_features_clist }
      }
  }

% "Normal" features [[[2
\seq_new:N \g__wisper_all_features_main_seq
\cs_new:Npn \__wisper_declare_feature:nnn #1#2#3
  {
    \seq_put_right:Nn \g__wisper_all_features_main_seq { #1 }
    \__wisper_declare_feature_aux:nnn { #1 } { #2 } { #3 }
  }
\cs_generate_variant:Nn \__wisper_declare_feature:nnn { nnx }
\cs_generate_variant:Nn \bool_show:n { x }
\cs_new:Npn \__wisper_declare_feature_expand_conditional:nnn #1#2#3
  {
    % Regex magic adapted from @egreg's code, https://tex.stackexchange.com/a/283944/111880
    \tl_set:Nn \l_tmpa_tl { #3 }
    % prefix any cs in the tl with \noexpand
    \regex_replace_all:nnN { (\cC.) } { \c{ exp_not:N } \1 } \l_tmpa_tl
    % protect #
    \regex_replace_all:nnN { \cP\# } { \c{ exp_not:N } \c{ __wisper_parameter_token: } } \l_tmpa_tl
    % remove the \noexpand from selected cs'
    \clist_map_inline:nn
      {
        __wisper_if_feature_enabled:nTF,
        __wisper_if_feature_enabled:nF,
        __wisper_if_feature_enabled:nT,
        __wisper_disable_features_group_except_group:nn,
        __wisper_if_document_class:nTF,
        __wisper_if_document_class:nF,
        __wisper_if_document_class:nT,
        __wisper_enable_feature:n,
        __wisper_activate_feature:n,
        __wisper_load_feature:n,
        IfDocClassTF,
        IfDocClassF,
        IfDocClassT,
      }
      {
        \regex_replace_all:nnN { \c{ exp_not:N }(\c{ ##1 }) } { \1 } \l_tmpa_tl
      }
    \__wisper_declare_feature:nnx { #1 } { #2 }
      {
        % Actually expand the conditonals only when the feature is activated.
        % This ensures that documentclass and the like are actually set.
        \exp_not:N \__wisper_shipout:x { \exp_not:o \l_tmpa_tl }
      }
  }

% Feature loading [[[2
\prg_new_conditional:Npnn \__wisper_should_load_feature:n #1 { T, F, TF }
  {
    %\bool_show:x { \bool_not_p:v {g__wisper_feature_ #1 _enabled_bool} }
    %\bool_show:c { g__wisper_feature_ #1 _loaded_bool }
    %\bool_show:x { \__wisper_if_engine_p:v {g__wisper_feature_ #1 _deactivated_for_engines_strlist} }
    %\bool_show:x { \__wisper_if_document_class_p:v {g__wisper_feature_ #1 _deactivated_for_classes_strlist} }
    % For some reason, using \bool_lazy_any:nTF here instead yields missing
    % number errors here...
    \bool_if:nTF
      {
        { \bool_not_p:v { g__wisper_feature_ #1 _enabled_bool } } ||
        { \bool_if_p:v { g__wisper_feature_ #1 _loaded_bool } } ||
        { \__wisper_if_engine_p:v { g__wisper_feature_ #1 _deactivated_for_engines_strlist } }
        %{ \__wisper_if_document_class_p:v { g__wisper_feature_ #1 _deactivated_for_classes_strlist } }
      }
      { \prg_return_false: } { \prg_return_true: }
  }
\cs_new:Npn \__wisper_load_feature:n #1
  {
    \__wisper_if_debug:nT { features }
      { \msg_warning:nnn { wisper } { check-loading-feature } { #1 } }
    \__wisper_should_load_feature:nT { #1 }
      {
        \__wisper_if_debug:nT { features }
          { \msg_warning:nnn { wisper } { loading-feature } { #1 } }
        \bool_gset_true:c { g__wisper_feature_ #1 _loaded_bool }
        \bool_if:cT { g__wisper_feature_ #1 _expl3_bool }
          { \__wisper_shipout:n { \ExplSyntaxOn } }
        \bool_if:cT { g__wisper_feature_ #1 _makeatletter_bool }
          { \__wisper_shipout:n { \makeatletter } }
        \use:c {g__wisper_feature_ #1 _code_tl}
        \bool_if:cT { g__wisper_feature_ #1 _makeatletter_bool }
          { \__wisper_shipout:n { \makeatother } }
        \bool_if:cT { g__wisper_feature_ #1 _expl3_bool }
          { \__wisper_shipout:n { \ExplSyntaxOff } }
      }
  }
\cs_new:Npn \__wisper_load_features_group:n #1
  { \__wisper_loop_features_groups:nN {#1} \__wisper_load_feature:n }

% Special case features: fonts [[[2
%\seq_new:N \g__wisper_all_features_font_seq
\seq_new:N \g__wisper_all_features_font_seq
\cs_new:Npn \__wisper_declare_font:nnn #1#2#3
  {
    %\seq_put_right:Nn \g__wisper_all_features_font_seq {#1}
    \seq_put_right:Nn \g__wisper_all_features_font_seq { #1 }
    \__wisper_declare_feature_aux:nnn { #1 } { #2, groups=font_only } { #3 }
  }
% Special case features: packages [[[2
\cs_new:Npn \__wisper_declare_ordinary_feature:nnn #1#2#3
  {
    \__wisper_declare_feature:nnn { #1 } { #2 }
      { \__wisper_shipout:n { #3 } }
  }
\seq_new:N \g__wisper_all_features_packages_seq
\cs_new:Npn \__wisper_declare_package:nnn #1#2#3
  {
    \seq_put_right:Nn \g__wisper_all_features_packages_seq { #1 }
    \__wisper_keys_define_doc:n
      {
        features/#1/options .code:n =
          { \__wisper_shipout:n { \PassOptionsToPackage { ##1 } { #1 } } },
      }
    \__wisper_declare_feature_aux:nnn { #1 } { #2 }
      {
        \__wisper_shipout:n
          {
            \usepackage { #1 }
            #3
          }
      }
  }
\cs_new:Npn \__wisper_declare_package:nn #1#2
  { \__wisper_declare_package:nnn { #1 } { #2 } { } }
\cs_new:Npn \__wisper_declare_package:n #1
  { \__wisper_declare_package:nnn { #1 } { } { } }
\cs_new:Npn \__wisper_declare_packages:n #1
  {
    \keyval_parse:NNn
      \__wisper_declare_package:n
      \__wisper_declare_package:nn
      { #1 }
  }

% Special case features: document classes [[[2
\seq_new:N \g__wisper_all_features_documentclass_seq
\cs_new:Npn \__wisper_store_classopt:nn #1#2
  { \prop_put:Nnn \g__wisper_classopts_prop { #1 } { #2 } }
\cs_generate_variant:Nn \__wisper_store_classopt:nn { nV }
\cs_new:Npn \__wisper_store_classopt:n #1
  % Need to expand this once in order for \tl_if_novalue:nTF to work.
  { \prop_put:Nno \g__wisper_classopts_prop { #1 } { \c_novalue_tl } }
\cs_new:Npn \__wisper_store_classopts_from_clist:n #1
  {
    \keyval_parse:NNn
      \__wisper_store_classopt:n
      \__wisper_store_classopt:nn
      { #1 }
  }
\cs_generate_variant:Nn \__wisper_store_classopts_from_clist:n { v }
\cs_new:Npn \__wisper_declare_documentclass:nn #1#2
  {
    \seq_put_right:Nn \g__wisper_all_features_documentclass_seq { class-#1 }
    \__wisper_keys_define_doc:n
      {
        % TODO: maybe store this as features/documentclass/options ?
        features/class-#1/options .meta:n =
          { features/class-#1/classoptions = { ##1 } }
      }
    \__wisper_declare_feature_aux:nnn { class-#1 } { #2 }
      {
        \__wisper_load_with_optional_arg:NNn
          \documentclass
          \g__wisper_classopts_prop
          { #1 }
      }
  }
\cs_new:Npn \__wisper_declare_documentclass:n #1
  { \__wisper_declare_documentclass:nn { #1 } { } }

% Special case features: document types [[[2
% TODO: maybe rename 'document type' -> 'preset'?
\seq_new:N \g__wisper_all_features_types_seq
\cs_new:Npn \__wisper_declare_document_type:nnn #1#2#3
  {
    \seq_put_right:Nn \g__wisper_all_features_types_seq { #1 }
    \__wisper_declare_feature_aux:nnn { #1 } { #2 }
      {
        \str_set:Nn \g__wisper_document_type_str { #1 }
        \__wisper_shipout:n { #3 }
      }
  }
\cs_new:Npn \__wisper_declare_document_type:nn #1#2
  { \__wisper_declare_document_type:nnn { #1 } { #2 } { } }

% Feature declarations [[[1

% Document classes [[[2
% TODO: raise an error if no documentclass is enabled
\__wisper_declare_documentclass:n { article }
\__wisper_declare_documentclass:n { book }
\__wisper_declare_documentclass:n { beamer }
\__wisper_declare_documentclass:n { scrbook }
\__wisper_declare_documentclass:n { scrreprt }
\__wisper_declare_documentclass:n { scrartcl }
\__wisper_declare_documentclass:n { scrlttr2 }
\exp_args:Nx \__wisper_declare_mutually_exclusive_features:n
  { \seq_use:Nn \g__wisper_all_features_documentclass_seq { , } }

% One feature per document class with things there's no good reason not to load
% with that class. [[[2
\__wisper_declare_document_type:nn { article }
  {
    classoptions = { a4paper },
    requires = { class-article },
  }
\__wisper_declare_document_type:nn { book }
  {
    classoptions = { a4paper },
    requires = { class-book },
  }
\__wisper_declare_document_type:nn { scrbook }
  {
    classoptions = { a4paper, BCOR=0mm, DIV=10, pagesize },
    requires = { class-scrbook, koma-misc },
  }
\__wisper_declare_document_type:nn { scrartcl }
  {
    classoptions = { a4paper, BCOR=0mm, DIV=10, pagesize },
    requires = { class-scrartcl, koma-misc },
  }
\__wisper_declare_document_type:nn { scrlttr2 }
  {
    classoptions = { a4paper },
    requires = { class-scrlttr2, koma-misc },
  }

% Document types, i.e. feature presets [[[2
\__wisper_declare_document_type:nn { exercise }  % [[[3
  {
    requires =
      {
        scrartcl,
        font-TexGyre,
        math,
        phys,
      },
  }
\__wisper_declare_document_type:nnn { paper }  % [[[3
  {
    % TODO: remove english after implementing languages properly
    classoptions = { twocolumn, english, DIV=14, fontsize=10pt },
    requires =
      {
        scrartcl,
        font-TexGyre,
        math,
        phys,
        biblatex-numeric-supercite,
        caption,
      },
  }
  {
    \captionsetup{
      format=plain,
      %font=small,
      font={sf,footnotesize},
      labelfont=sc,
      margin=0.1\linewidth,
      justification=RaggedRight
    }
    \numberwithin{equation}{section}
  }
\__wisper_declare_document_type:nnn { handout }  % [[[3
  {
    % TODO: remove english after implementing languages properly
    classoptions = { twocolumn, english, DIV=14, fontsize=10pt },
    requires =
      {
        scrartcl,
        font-TexGyre,
        math,
        phys,
        % biblatex-numeric-supercite,
        biblatex-alphabetic,
        biblatex={maxcitenames=1},
        caption,
      },
  }
  {
    \captionsetup{
      format=plain,
      %font=small,
      font={sf,footnotesize},
      labelfont=sc,
      margin=0.1\linewidth,
      justification=RaggedRight
    }
    % \numberwithin{equation}{section}
  }
\__wisper_declare_document_type:nnn { simple-notes }  % [[[3
  {
    % TODO: remove english after implementing languages properly
    classoptions = { english, DIV=10, fontsize=10pt },
    requires =
      {
        scrartcl,
        font-TexGyre,
        math,
        phys,
        biblatex-numeric-supercite,
        caption,
      },
  }
  {
    \captionsetup{
      format=plain,
      %font=small,
      font={sf,footnotesize},
      labelfont=sc,
      calcwidth=0.9\linewidth,
      justification=RaggedRight
    }
    \numberwithin{equation}{section}
  }
\__wisper_declare_document_type:nnn { presentation }  % [[[3
  {
    expl3=true,
    makeatletter=true,
    classoptions = { english, smaller },
    requires = {
      class-beamer,
      font-fira,
      math,
      phys,
      %biblatex-numeric-supercite,
      biblatex={doi=false, arxiv=false},
      biblatex-alphabetic,
      pgfpages,  % for notes on second screen
      setspace,  % control line stretch
    },
  }
  {
    % TODO: devise a way to properly cite image references, cf.
    % the cite:online hack.
    % TODO: move the slide environments here
    \let\footnotesize\tiny
    \let\beamerfootnote\footnote
    \RenewDocumentCommand \footnote { m }
      { \beamerfootnote[frame]{#1} }
    %\NewDocumentCommand \footnotetextCite { m }
    %  { \footnotetext[frame]{#1} }
    \usetheme{metropolis}
    \metroset
      {
        sectionpage=none,
        numbering=fraction,
        progressbar=frametitle,  % head, foot, frametitle, none
        block=fill,  % transparent, fill {for theorem and example environments}
      }
    %\setbeamertemplate{footline}[page number]{}
    \setbeamertemplate{footline}[frame number]{}
    \setbeamerfont{caption}{size=\footnotesize}
    % compat with enumitem package
    % TODO: make this conditional on enumitem being loaded
    \setlist[itemize,1]
      { label=\protect\usebeamertemplate*{itemize~item} }
    \setlist[itemize,2]
      { label=\protect\usebeamertemplate*{itemize~subitem} }
    \setlist[itemize,3]
      { label=\protect\usebeamertemplate*{itemize~subsubitem} }
    % https://tex.stackexchange.com/questions/31616/how-to-use-shortjournal-with-biblatex-and-biblatex-chem
    \renewbibmacro*{journal}{%
      \iffieldundef{shortjournal}
        {%
          \iffieldundef{journaltitle}
            {}
            {%
              \printtext[journaltitle]
                {%
                  \printfield[titlecase]{journaltitle}%
                  \setunit{\subtitlepunct}%
                  \printfield[titlecase]{journalsubtitle}%
                 }%
             }%
        }
        {\printtext[journaltitle]{\printfield[titlecase]{shortjournal}}}%
    }
    % https://tex.stackexchange.com/questions/368757/add-square-brackets-to-footfullcite-in-beamer, but
    % fixed to be less intrusive
    \def \@makefnmark
      {
        \hbox
          {
            \,
            \bgroup
              \usebeamercolor[fg]{footnote mark}
              \usebeamerfont*{footnote mark}
              [
              \@thefnmark
              ]
            \egroup
          }
      }
    \AtBeginDocument
      {
        \bgroup
          %\showthe\baselineskip
          \footnotesize
          %\showthe\baselineskip
          % Some expandafter trickery needed because 
          % \setlength\skip@{\baselineskip}
          % for some reason ends up as
          % \setlength\skip @{\baselineskip}
          % in the preamble (note the space) which obviously fails
          \setlength { \csname skip@\endcsname } { .5\baselineskip }
          %\showthe \footnotesep
          \expandafter \global \expandafter \footnotesep
            \expandafter = \csname skip@\endcsname 
          %\showthe \footnotesep
        \egroup
      }

    %\AtBeginDocument{\setstretch{1.5}}
    % This is copied from beamerinnerthememetropolis.sty (and also made less intrusive) 
    % with reduced linespacing (\setstretch)
    \setbeamertemplate{footnote}{
      \parindent 0em\noindent
      \raggedright\setstretch{1.0}
      \hbox to 1.8em{\hfil\insertfootnotemark}\insertfootnotetext\par
    }
  }
\__wisper_declare_document_type:nn { tufte-book }  % [[[3
  {
    requires =
      {
        scrbook,
        twoside,
        twoside-floats,
        sidenotes,
        biblatex-numeric-supercite,
        font-TexGyre,
        footnotecite,
        boxes,
        paul-tol-colors,
      },
  }


% Fonts [[[2
% Packages [[[3
\__wisper_declare_packages:n
  {
    % These packages are not supposed to be loaded in
    % \__wisper_load_features_group:n { main },
    % but manually in \__wisper_load_features_group:n { font }
    newpxmath = { groups=font_only },
    fontspec = { groups=font_only },
    newpxtext = { groups=font_only },
    lmodern = { groups=font_only },
    FiraSans = { groups=font_only },
    FiraMono = { groups=font_only },
    mathdesign = { groups=font_only },
    mathpazo = { groups=font_only },
    cabin = { groups=font_only },
    beramono = { groups=font_only },
  }
\__wisper_declare_font:nnn { font-lmodern }  % [[[3
  {
    requires = lmodern,
  }
  {
    \__wisper_load_feature:n { lmodern }
  }
\__wisper_declare_font:nnn { font-fira }  % [[[3
  {
    requires = {
      FiraMono,
      FiraSans = sfdefault,
    },
  }
  {
    % Mozilla Fira Sans, requires XeLaTeX or LuaLaTex TODO: raise error
    \__wisper_load_feature:n {FiraSans}
    \__wisper_load_feature:n {FiraMono}
  }
\__wisper_declare_font:nnn { font-garamond }  % [[[3
  {
    requires = {
      mathdesign = urw-garamond,
    },
  }
  {
    % URW-Garamond: A free garamond font, supposedly good for books but to
    % fragile for presentations. Math fonts provided by the mathdesign project
    % FIXME: maybe drop this? PagellaX is better anyway. At least give a
    % warning.
    % TODO: matching sans font
    \__wisper_load_feature:n {mathdesign}
  }
\__wisper_declare_font:nnn { font-palatino }  % [[[3
  {
    requires = {
      mathpazo = osf,
    },
  }
  {
    \__wisper_load_feature:n {mathpazo}
  }
\__wisper_declare_font:nnn { font-TexGyre }  % [[[3
  {
    requires = {
      amsthm,
      newpxtext = largesc,
      newpxmath = vvarbb,
      fontspec = no-math,
      %cabin = type1,
      %beramono = {scaled=.85},
    },
  }
  {
    % preload amsthm to suppress error due to newpxmath redfining \openbox
    \__wisper_shipout:n
      { \renewcommand{\rmdefault}{zpltlf} }
    %\__wisper_load_feature:n {beramono}  % used only by \mathtt
    %\__wisper_load_feature:n {cabin}  % used only by \mathsf
    \__wisper_load_feature:n {amsthm}
    \__wisper_load_feature:n {newpxmath}

    \__wisper_switch_engine:nF
      {
        { luatex }
          {
            \__wisper_load_feature:n {fontspec}
            % TODO: ensure correct small caps, \usepackage[largesc]{newpxtext}
            % (but the package isn't loaded here...)
            \__wisper_shipout:n
              {
                \setmainfont{TeXGyrePagellaX}[Numbers=OldStyle]
                \setsansfont{TeXGyreHeros}
                % TODO: where appropriate, check for \liningnumtext to be defined and
                % use it.
                \newfontfamily\liningnumtext{TeXGyrePagellaX}[Numbers=Lining]
                \tl_gset:Nn \PlotFont { \sffamily }
              }
          }
        { xetex }
          {
            \PackageError{---}{No~XeTeX~support~here.}
          }
      }
      {
        % Other TeX
        \__wisper_load_feature:n {newpxtext}
        \__wisper_shipout:n
          { \useosf }
      }

      \__wisper_shipout:n
        { \linespread{1.05} }
    }


% Generic [[[2
\__wisper_declare_packages:n
  {
    enumitem = {
      enabled,
      options = { inline },
      % doesn't play well with overlay specifications
      deactivate_for_classes = { beamer },
    },
    calc = enabled,
    ragged2e = enabled,
    xcolor = { enabled, groups=font_only },
    url = {
      enabled,
      options = { hyphens },
      % loaded early by hyperref which is loaded way to early by beamer...
      % loading it again gives an option clash.
      deactivate_for_classes = { beamer },
      groups=font_only,
    },
    hyperref = enabled,
    sidenotes,
    %babel = { enabled, options = { main=english } },
    babel = { enabled },  %, groups=font_only },
    fontenc = { enabled, options = { T1 }, groups=font_only },
    standalone,
    csquotes = { enabled },  %, groups=font_only },
    microtype = { enabled, groups=font_only },
    inputenc = {
      enabled,
      options = { utf8 },
      % Suppress inputenc warning for utf8 engines
      deactivate_for_engines = { luatex, xetex },
      groups=font_only,
    },
    fancyhdr,
    amsthm = { groups = font_only },
    pgfpages,
    soul,
    setspace,
  }

\__wisper_declare_ordinary_feature:nnn { nonnum-section-commands }
  {}
  {
    % unnumbered section that shows up in the TOC
    \newcommand{\tocsection}[1]{\section*{#1}\addcontentsline{toc}{section}{#1}}
    % non-numbered subsection that works properly with hyperref
    \IfDocClassT { book, scrbook }
      { \newcommand{\nonumchapter}[1]{\phantomsection\addcontentsline{toc}{chapter}{#1}} }
    \newcommand{\nonumsection}[1]{\phantomsection\addcontentsline{toc}{section}{#1}}
    \newcommand{\nonumsubsection}[1]{\phantomsection\addcontentsline{toc}{subsection}{#1}}
    \newcommand{\nonumsubsubsection}[1]{\phantomsection\addcontentsline{toc}{subsubsection}{#1}}
  }

% Colors  [[[2
\__wisper_declare_package:nn { paul-tol-colors }
  { disabled, groups=font_only }

% Bibliography [[[2
\__wisper_declare_package:nn { biblatex }
  {
    disabled,
    options = { hyperref=true },
  }

\__wisper_declare_ordinary_feature:nnn { biblatex-picture-sources }
  % Usage:
  %\usepackage{filecont ents}
  %\begin{filecontent s}{pictures.bib}
  %@online {pic:source:foo,
  %  title = {Figure~\ref{pic:foo}},
  %  url = {https://example.com/pic.jpg},
  %  urldate = {2018-01-05},
  %}
  %\end{filecont ents}
  %\addbibresource{pictures.bib}
  % ...
  %\begin{document}
  % ...
  % \caption{...\cite{pic:source:foo}}
  { requires = biblatex }
  {
    \DeclareBibliographyDriver{cite:online}
    {
      \usebibmacro{author+title}
      %\usebibmacro{note+pages}
      \setunit{\addperiod\addspace}
      %\usebibmacro{url+urldate}
      \usebibmacro{url}
      \usebibmacro{finentry}
    }
  }

\__wisper_declare_ordinary_feature:nnn { biblatex-backref }
  {
    disabled,
    requires = {
      biblatex = {
        backref=true,
      },
    },
  }
  { }

\__wisper_declare_ordinary_feature:nnn { biblatex-default-verbosity }
  {
    disabled,
    requires = {
      biblatex = {
        url=false,
        isbn=false,%  DOI only
        maxcitenames=1,
        maxbibnames=3,
        citereset=section,
      },
    },
  }
  { }

\__wisper_declare_ordinary_feature:nnn { biblatex-wip-interface }
  % TODO: actually implement this.
  {
    declare~options =
      {
        style .choice:,
        style / super .meta:n = {},
        style / bracket .meta:n = {},

        label .choice:,
        label / numberic .meta:n = {},
        label / alphabetic .meta:n = {},

        enable~footnote .meta:n =
          {
            \__wisper_enable_feature:n { multiple-footnotes },
          },
      }
  }
  {
  }

\__wisper_declare_ordinary_feature:nnn { biblatex-verbose-note }
  {
    disabled,
    requires = {
      biblatex = {
        % many of these options can only be given in \usepackage and not later, unfortunately..
        style=verbose-note,
      },
      biblatex-backref,
      biblatex-default-verbosity,
    },
  }
  { }

\__wisper_declare_ordinary_feature:nnn { biblatex-alphabetic }
  {
    disabled,
    requires = {
      biblatex = {
        % many of these options can only be given in \usepackage and not later, unfortunately..
        style=alphabetic,
      },
      biblatex-backref,
      biblatex-default-verbosity,
    },
  }
  { }

\__wisper_declare_ordinary_feature:nnn { biblatex-authoryear-comp }
  {
    disabled,
    requires = {
      biblatex = {
        % many of these options can only be given in \usepackage and not later, unfortunately..
        style=authoryear-comp,
      },
      biblatex-backref,
      biblatex-default-verbosity,
    },
  }
  { }

% TODO: separate the concepts of superscript and footnote citations
% TODO: be bold enough to \renewcommand\cite
\__wisper_declare_ordinary_feature:nnn { biblatex-numeric-supercite }
  % Inspired and partially copied from
  %   http://www.khirevich.com/latex/footnote_citation/
  % TODO: ensure that this works when there are non-cite footnotes on the same page
  {
    disabled,
    requires = {
      biblatex = {
        %bibstyle=authoryear,
        bibstyle=numeric,
        citestyle=latex-common/custom-numeric-comp,
        %citestyle=numeric-comp,
      },
      biblatex-backref,
      biblatex-default-verbosity,
      footnotecite,
    },
    expl3 = true,
  }
  {
    \newlength { \spc }
    \cs_new_eq:NN \__citeX_citecommand: \superfullcite
    %\cs_new_eq:NN \__citeX_citecommand: \supershortnotecite
    \cs_new:Npn \__citeX_nomove:nnn #1#2#3
      {
        \tl_if_novalue:nTF {#2}
          { \__citeX_citecommand: {#3} }
          {
            \tl_if_novalue:nTF {#2}
              { \__citeX_citecommand:[#1]{#3} }
              { \__citeX_citecommand:[#1][#2]{#3} }
          }
      }
    \cs_new:Npn \__citeX_move:nnnN #1#2#3#4
      {
        \settowidth \spc {#4}
        \dim_add:Nn \spc { -1.8\spc }

        #4\hspace* { \spc }

        \__citeX_nomove:nnn {#1} {#2} {#3}
      }
    \NewDocumentCommand \citeX { o o m }
      {
        \peek_charcode_ignore_spaces:NTF .
          { \__citeX_move:nnnN {#1} {#2} {#3} }
          {
            \peek_charcode_ignore_spaces:NTF ,
              { \__citeX_move:nnnN {#1} {#2} {#3} }
              {
                \peek_charcode_ignore_spaces:NTF :
                  { \__citeX_move:nnnN {#1} {#2} {#3} }
                  {
                    \peek_charcode_ignore_spaces:NTF ;
                      { \__citeX_move:nnnN {#1} {#2} {#3} }
                      {
                        \__citeX_nomove:nnn {#1} {#2} {#3}
                      }
                  }
              }
          }
      }
  }

\__wisper_declare_ordinary_feature:nnn { biblatex-alphabetic-supercite }
  % This is supposed to do the same as biblatex-numeric-supercite, but
  % with the alphabetic labels in square brackets in the superscripts
  % and footnotes
  { }
  {
    % FIXME: implement
  }

\__wisper_declare_feature_expand_conditional:nnn { footnotecite }
  {
    expl3=true,
    requires-conditional = {
      { { ! \__wisper_if_document_class_p:n { beamer } } { multiple-footnotes } },
    },
  }
  {
    \IfDocClassTF { beamer }
      {
        % bigfoot+beamer crashes (incomplete iffalse ...)
        %\DeclareDocumentCommand \footnotetextCite { r[] } { \footnotetext[#1][frame] }
        \DeclareDocumentCommand \footnotetextCite { r[] } { \footnotetext[#1] }
        \cs_gset_eq:NN \footnotemarkCite \footnotemark
        %\cs_gset_eq:NN \footnotetextCite \footnotetext
        \cs_gset_eq:NN \footnoteCite \footnote
      }
      {
        \DeclareNewFootnote{Cite} 
      }
  }


% Page-layout: one-/twoside etc [[[2
\__wisper_declare_packages:n
  { changepage }

\__wisper_declare_ordinary_feature:nnn { oneside }
  % This feature mostly exists to provide dummy commands for justification etc.
  % so that twoside documents can easily be compiled onesided.
  {
    enabled,
    expl3=true,
  }
  {
    \cs_new_eq:NN \raggedoutside \raggedright
    \NewDocumentEnvironment {flushinside} {}
      { \bgroup \flushleft }
      { \egroup }
  }
\__wisper_declare_ordinary_feature:nnn { twoside }
  {
    disabled,
    classoptions = { twoside },
    requires = {
      changepage = strict,
    },
    expl3=true,
  }
  {
    \cs_new:Npn \raggedoutside
      {
        \checkoddpage
        \ifoddpage
          \RaggedRight
        \else
          \RaggedLeft
        \fi
      }
    \NewDocumentEnvironment {flushinside} {}
      {
        \checkoddpage
        \bgroup
        \ifoddpage
          \flushleft
        \else
          \flushright
        \fi
      }
      {
        \egroup
      }
  }
\__wisper_declare_mutually_exclusive_features:n { oneside, twoside }

% Layout for KOMA [[[2
\__wisper_declare_feature_expand_conditional:nnn { koma-misc }
  { }
  {
    \IfDocClassT{koma}
      {
        % TODO: make the use of boldmath configurable, cf. 
        % https://tex.stackexchange.com/questions/108894/typesetting-formulas-in-section-titles-title-bold-toc-entry-isnt#comment238645_108894
        % https://tex.stackexchange.com/questions/41379/automatically-typeset-math-in-section-headings-in-bold-face#124311
        % Fix chapter/section titles defaulting to sans (i.e. CM) fonts
        \setkomafont{disposition}{\sffamily\bfseries\boldmath}
        \KOMAoptions{headings=normal}
        % Fix fonts in the toc
        \IfDocClassT {scrbook}
          { \setkomafont{chapterentry}{\sffamily\bfseries\boldmath} }
        % fix item font in descriptions and enumerates
        \setkomafont{descriptionlabel}{\normalfont\bfseries\boldmath}
        \setkomafont{labelinglabel}{\normalfont\bfseries\boldmath}
        % Suppress warnings on font fallback
        \renewcommand\labelitemi{{\fontfamily{cmr}\selectfont\textbullet}}
        \renewcommand\labelitemiii{{\fontfamily{cmr}\selectfont\textasteriskcentered}}
        \renewcommand\labelitemiv{{\fontfamily{cmr}\selectfont\textperiodcentered}}
        
        % Titlepage
        \IfDocClassT { scrbook }  % TODO: better conditional
          { \KOMAoptions{titlepage=firstiscover} }
        
        % Footnotes
        \KOMAoptions{footnotes=multiple}  % comma-separate footnote superscripts
        \renewcommand{\multfootsep}{,}
        
        % Header/Footer
        \usepackage[draft=false]{scrlayer-scrpage}
        \pagestyle{scrheadings}
        \IfDocClassTF { scrbook }  % TODO: better conditional
          {
            \automark[chapter]{chapter}
            \automark*[section]{}
          }
          {
            \automark[section]{section}
          }
        \ihead{}
        \chead{\headmark}
        \ohead{\pagemark}
        \ifoot{}
        \cfoot{}
        \ofoot{}
        %\KOMAoptions{headsepline=true}
        %\KOMAoptions{footsepline=:0.5\textwidth, olines}
      }
    }

% Footnotes [[[2
\__wisper_declare_package:n { bigfoot }

\__wisper_declare_ordinary_feature:nnn { multiple-footnotes }
  {
    requires = bigfoot,
  }
  {
  }

\__wisper_declare_feature_expand_conditional:nnn { alphabetic-default-footnote }
  {
    expl3=true,
  }
  {
    \__wisper_if_feature_enabled:nTF { bigfoot }
      {
        \DeclareNewFootnote{default}[alph]
        \cs_gset_eq:NN \footnote \footnotedefault
        \cs_gset_eq:NN \footnotemark \footnotemarkdefault
        \cs_gset_eq:NN \footnotetext \footnotetextdefault
      }
      {
        \cs_gset:Npn \thefootnote { \alph{footnote} }
      }
  }

% Hyperref [[[2
\__wisper_declare_ordinary_feature:nnn { hyperref-bookmarks-default }
  {
    enabled,
    requires = {
      hyperref = {
        bookmarksopen=true,
        bookmarksopenlevel=3,
      }
    },
  }
  { }
\__wisper_declare_ordinary_feature:nnn { hyperref-black }
  {
    requires = {
      hyperref = {
        hidelinks,
      }
    },
  }
  { }
\__wisper_declare_ordinary_feature:nnn { hyperref-pale-colors }
  {
    enabled,
    requires = {
      paul-tol-colors,
      hyperref = {
        % TODO: this required another package!
        colorlinks=true,
        %linkcolor=black,  % for internal links, color is just too much
        linkcolor=mark-dark-green,
        citecolor=mark-dark-cyan,
        filecolor=mark-dark-green,
        urlcolor=mark-dark-blue,
      }
    },
  }
  { }
\__wisper_declare_mutually_exclusive_features:n
  { hyperref-black, hyperref-pale-colors }

% Code display [[[2
\__wisper_declare_packages:n
  { minted }

\__wisper_declare_ordinary_feature:nnn { minted-default }
  {
    requires = { minted },
  }
  {
    \input{common_code.tex}
  }

\__wisper_declare_ordinary_feature:nnn { listings }
  { requires = minted }
  {
  }

% Math, physics [[[2
\__wisper_declare_ordinary_feature:nnn { math }
  { groups=font_only }
  {
    \input{common_math.tex}
  }

\__wisper_declare_ordinary_feature:nnn { phys }
  { requires = math, groups=font_only }
  {
    \input{common_phys.tex}
  }

\__wisper_declare_ordinary_feature:nnn { plots }
  {
    expl3=true,
  }
  {
    \input{common_plots.tex}
    \tl_if_exist:NF \PlotFont { \tl_gclear:N \PlotFont }
  }

% Tables, figures [[[2
\__wisper_declare_packages:n
  {
    float = enabled,
    rotating = enabled,
    booktabs = enabled,
    array = enabled,
    multirow,
    tabu,
    caption = enabled,
    subcaption = enabled,
    graphicx = enabled,
  }

\__wisper_declare_ordinary_feature:nnn { array-par-columns }
  { requires = array }
  {
    % https://tex.stackexchange.com/a/2442/111880
    % https://tex.stackexchange.com/a/12712/111880
    \newcolumntype{L}[1]{>{\raggedright\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
    \newcolumntype{C}[1]{>{\centering\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
    \newcolumntype{R}[1]{>{\raggedleft\let\newline\\\arraybackslash\hspace{0pt}}m{#1}}
  }

% TODO: caption-font feature option to specify font/labelfont/... from the
% document type feature and only set the alignment here
\__wisper_declare_feature_expand_conditional:nnn { twoside-floats }
  { requires = caption }
  {
    \DeclareCaptionStyle{myfigure}{
      font=footnotesize,%
      labelfont=sc,%
    }
    \captionsetup{style=myfigure}  % default

    \__wisper_if_feature_enabled:nT {twoside}
      {
        \DeclareCaptionJustification{raggedoutside}{\raggedoutside}

        \DeclareCaptionStyle{marginfigure}{
          justification=raggedoutside,%
          font={sf,footnotesize},%
          labelfont=sc,%
        }

        \DeclareCaptionStyle{margintable}{
          justification=raggedoutside,%
          font={sf,footnotesize},%
          labelfont=sc,%
        }

        \DeclareCaptionStyle{sidecaption}{
          justification=raggedoutside,%
          font={sf,footnotesize},%
          labelfont=sc,%
        }
        \newlength{\realmarginparwidth}
        \setlength{\realmarginparwidth}{\marginparwidth}
        \addtolength{\realmarginparwidth}{\marginparsep}

        \DeclareCaptionStyle{widetable}{
          %justification=raggedoutside,%
          font={sf,footnotesize},%
          labelfont=sc,%
          margin={0pt, \realmarginparwidth}
        }
      }
  }

% Drafts [[[2

\__wisper_declare_package:nnn { showlabels }
  { options = inner }
  {
    \renewcommand{\showlabelfont}{\tiny\ttfamily}
    \showlabels{cite}
    \showlabels{ref}
    \showlabels{begin}
  }

\__wisper_declare_ordinary_feature:nnn { draft-tools }
  {}
  {
    \newcounter{todonotecounter}
    \NewDocumentCommand \margintodo {s o m} 
      {
        \stepcounter{todonotecounter}
        \IfBooleanTF{#1}{}{%
          \marginpar{%
            \IfValueT{#2}{\vspace{#2}}%
            \raggedoutside
            \footnotesize%
            \fcolorbox{red}{white}{\color{red} \thetodonotecounter}%
            #3%
          }
        }
      }
  }

% Boxes [[[2
\__wisper_declare_packages:n
  {
    mdframed,
    xtemplate,
  }
\__wisper_declare_ordinary_feature:nnn { boxes }
  {
    requires = 
      {
        mdframed,
        xtemplate,
        xcolor,
      },
    expl3=true,
  }
  {
    \dim_new:N \l__wisper_left_margin_dim
    \DeclareObjectType { fancy-box } { 1 }
    \DeclareTemplateInterface { fancy-box } { wisper } { 1 }
      {
        title-format: tokenlist = { \bfseries { \Title } },
        bar-location: choice {margin, flush} = flush,
        bar-width: length = 0.15cm,
        bar-colour: tokenlist = {black},
        bg-colour: tokenlist = {white},
      }
    \DeclareTemplateCode { fancy-box } { wisper } { 1 }
      {
        title-format = \l__wisper_title_format_tl,
        bar-location =
          {
            margin = { \bool_gset_true:N \l__wisper_bar_in_margin_bool },
            flush = { \bool_gset_false:N \l__wisper_bar_in_margin_bool },
          },
        bar-width = \l__wisper_bar_width_dim,
        bar-colour = \l__wisper_bar_colour_tl,
        bg-colour = \l__wisper_bg_colour_tl,
      }
      {
        \AssignTemplateKeys
        \bool_if:NTF \l__wisper_bar_in_margin_bool
          { \dim_set:Nn \l__wisper_left_margin_dim { -1cm} }
          { \dim_set:Nn \l__wisper_left_margin_dim { 0pt } }
        \__wisper_mdfdefinestyle:nx { #1 }
          {
            skipabove=0.3 \exp_not:N \baselineskip,
            skipbelow=0.3 \exp_not:N \baselineskip,
            rightline=false,
            leftline=true,
            topline=false,
            bottomline=false,
            linecolor=\l__wisper_bar_colour_tl,
            backgroundcolor=\l__wisper_bg_colour_tl,
            innerleftmargin=5pt,
            innerrightmargin=5pt,
            innertopmargin=3pt,
            innerbottommargin=3pt
            leftmargin=\l__wisper_left_margin_dim,
            rightmargin=0cm,
            linewidth=\l__wisper_bar_width_dim,
          }
      }
    \cs_new_nopar:Npn \NewFancyBox #1#2
      {
        \__wisper_xtemplate_DeclareInstance:nxnn
          { fancy-box }
          { \tl_trim_spaces:n { #1 } }
          { wisper }
          { #2 }
        \__wisper_xtemplate_UseInstance:nxxw
          { fancy-box }
          { \tl_trim_spaces:n { #1 } }
          { \tl_trim_spaces:n { #1 } }
        \use:x
          {
            \exp_not:N \newmdenv[style=\tl_trim_spaces:n { #1 }]{ \tl_trim_spaces:n { #1 } }
          }
      }
    \cs_new_nopar:Npn \WrapInFancyBox #1#2
      {
        % mdframed also provided \newmdtheoremenv, but that only supports
        % ntheorem. Anyway, this kind of wrapper gives better separation
        % between different packages.
        \BeforeBeginEnvironment { #1 } { \begin { #2 } }
        \AfterEndEnvironment { #1 } { \end { #2 } }
      }
  }

% Loading orders [[[1

% TODO: automatically set these clists from \__wisper_declare_feature:
\seq_gset_from_clist:Nn \g__wisper_all_features_early_packages_seq
  {
    inputenc,
    babel,
    fontenc,
    standalone,
    pgfpages,
  }
\seq_gset_from_clist:Nn \g__wisper_all_features_main_packages_seq
  {
    koma-misc,  % must be after fonts to adjust dimensions

    % colors
    xcolor,
    paul-tol-colors,

    % load minted before csquotes to suppress a warning due to a common package
    % they load
    minted,
    csquotes,  % context-sensitive quotes
    microtype,
    xtemplate,

    sidenotes,

    enumitem,
    float,
    calc,
    fancyhdr,
    ragged2e,
    url,
    mdframed,
    setspace,
    soul,

    % tables
    rotating,
    booktabs,
    array,
    multirow,
    tabu,

    % Graphics
    graphicx,  % advanced key=value arguments for \includegraphics
    caption,
    subcaption,

    biblatex,

    math,
    phys,


    % Packages that need to be loaded last [[[2
    bigfoot,
    hyperref,
    showlabels,

    changepage,

  }

\__wisper_declare_feature:nnn { font-only }
  { groups = font_only }
  { \__wisper_disable_features_group_except_group:nn { all } { font_only } }

% TODO: Option to embed any file that is \input
\cs_new:Npn \__wisper_write_preamble:n #1
  {
    \iow_new:N \__wisper_preamble_iow
    \iow_open:Nn \__wisper_preamble_iow {#1}
    \seq_map_inline:Nn \g__wisper_preamble_seq
      {
        \tl_if_empty:nF {##1}
          {
            \iow_now:Nx \__wisper_preamble_iow
            {
              \exp_not:n {##1} % \iow_newline:
            }
          }
      }
    \iow_close:N \__wisper_preamble_iow
  }

\cs_new:Npn \__wisper_build_preamble:n #1
  {
    \__wisper_enable_features:n {#1}

    % Traverse dependencies.
    \__wisper_activate_features_group:n { types }
    \__wisper_activate_features_group:n { documentclass }
    \__wisper_activate_features_group:n { early_packages }
    \__wisper_activate_features_group:n { font }
    \__wisper_activate_features_group:n { main_packages }
    \__wisper_activate_features_group:n { main }

    \__wisper_load_feature:n { font-only }

    %\__wisper_pass_classoptions:
    \__wisper_load_features_group:n { documentclass }
    %\__wisper_shipout:n { \ExplSyntaxOn }

    % Early Package loads
    \__wisper_load_features_group:n { early_packages }
    \__wisper_load_features_group:n { font }
    % Adjust layout.
    \__wisper_if_document_class:nT {koma}
      { \__wisper_shipout:n { \KOMAoptions{DIV=last} } }

    %% requires amsmath
    %\IfDocClassTF{book, scrbook}
    %  {\numberwithin{equation}{chapter}}
    %  {\numberwithin{equation}{section}}

    %\IfDocClassTF {beamer}
    %  { \__wisper_select_package_preset:nn {biblatex} {presentation} }
    %  { \__wisper_select_package_preset:nn {biblatex} {book} }
    %\__wisper_select_package_preset:nn {hyperref} {pale-colors}
    % here: enable features
    \__wisper_load_features_group:n { main_packages }
    \__wisper_load_features_group:n { types }
    \__wisper_load_features_group:n { main }
    % TODO: load all features that are not explicitly given in the loading orders

    %\__wisper_shipout:n { \ExplSyntaxOff }
  }



% User interface [[[1
\cs_new_eq:NN \DocumentStyle \__wisper_keys_set_doc:n
\NewDocumentCommand \Preamble { m }
  {
    \__wisper_build_preamble:n { #1 }
    \__wisper_write_preamble:n {preamble.tex}
    %\seq_use:Nn \g__wisper_preamble_seq { ~~~ }
    \input{preamble.tex}
  }



\ExplSyntaxOff

% vim: ts=2 sw=2 et fdm=marker fmr=[[[,]]]:
